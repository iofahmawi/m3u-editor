<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>محرر قوائم تشغيل M3U/M3U8</title>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
    
    <style>
        /* Warm & Minimalist Theme with Final Polishing */
        :root {
            --primary-color: #e67e22; /* Carrot Orange */
            --primary-hover: #d35400;
            --secondary-color: #34495e; /* Wet Asphalt Blue */
            --secondary-hover: #2c3e50;
            --delete-color: #c0392b; /* Pomegranate Red for delete actions */
            --delete-hover: #a93226;
            --button-delete-color: #546e7a; /* Neutral dark grey for delete buttons */
            --button-delete-hover: #455a64;
            --background-color: #fdfcfb; /* Very Light Beige */
            --container-bg-color: #ffffff;
            --text-color: #5D4037; /* Warm Dark Brown */
            --text-light-color: #ffffff;
            --border-color: #e0e0e0;
            --row-alt-color: #f7f7f7;
            --selected-row-color: #fdebd0; /* Light Orange */
        }

        html {
            height: 100%;
        }

        body {
            font-family: 'Arial', sans-serif;
            background-color: var(--background-color);
            color: var(--text-color);
            margin: 0;
            padding: 20px;
            direction: rtl;
            display: flex;
            flex-direction: column;
            min-height: 100vh;
            box-sizing: border-box;
        }

        button, a, [onclick], .upload-area {
            -webkit-tap-highlight-color: transparent;
        }

        .container {
            max-width: 1100px; width: 100%; margin: 20px auto;
            background: var(--container-bg-color);
            padding: 30px; border-radius: 12px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.08);
            box-sizing: border-box;
            border: 1px solid var(--border-color);
        }
        h1 { color: var(--primary-color); text-align: center; margin-bottom: 20px; }
        .page-title a {
            color: inherit;
            text-decoration: none;
            cursor: pointer;
        }

        .upload-area {
            text-align: center; padding: 20px;
            border: 2px dashed var(--border-color);
            border-radius: 12px; margin-bottom: 20px; cursor: pointer;
            transition: border-color 0.3s; box-sizing: border-box;
        }
        .upload-area:hover, .upload-area.dragging {
            border-color: var(--primary-color);
            background-color: #fffaf5;
        }
        .upload-label {
            background-color: var(--primary-color);
            color: var(--text-light-color);
            padding: 0 25px;
            height: 40px;
            line-height: 40px;
            border-radius: 8px; cursor: pointer;
            font-weight: bold; display: inline-block;
            transition: background-color 0.3s; border: none; margin-top: 10px;
        }
        .upload-label:hover { background-color: var(--primary-hover); }

        .action-btn {
            background-color: var(--secondary-color);
            color: white; 
            padding: 7.5px 20px; 
            border-radius: 8px;
            cursor: pointer; font-weight: bold; border: none;
            transition: background-color 0.3s, opacity 0.3s;
            margin: 10px 5px; flex-shrink: 0;
            white-space: nowrap;
        }
        .action-btn:hover:not(:disabled) { background-color: var(--secondary-hover); }
        .action-btn.delete-btn { background-color: var(--button-delete-color); }
        .action-btn.delete-btn:hover { background-color: var(--button-delete-hover); }
        .action-btn.export-btn { background-color: var(--primary-color); }
        .action-btn.export-btn:hover { background-color: var(--primary-hover); }

        .action-btn:disabled {
            background-color: var(--secondary-color);
            cursor: not-allowed; opacity: 0.6;
        }
        .action-btn:disabled:hover { background-color: var(--secondary-color); }

        #manageGroupsButton, #openSortModalButton, #removeDuplicatesButton, #addChannelButton, #openMergeModalButton, #openExportModalButton, #bulkActionsButton { display: none; }
        #mainControls { text-align: center; margin-bottom: 20px; }
        .button-row { display: flex; justify-content: center; align-items: center; flex-wrap: wrap; gap: 10px; margin-bottom: 10px; }
        #initialButtonsRow { justify-content: space-between; }
        #initialButtonsRow button { flex: 1; margin: 0; }
        @media (max-width: 768px) { #mainControls button { width: 45%; margin: 5px 0; } #initialButtonsRow { flex-direction: column; } #initialButtonsRow button { width: 100%; } }
        @media (min-width: 769px) { #mainControls button { width: auto; min-width: 150px; } #initialButtonsRow button { width: auto; } }

        #searchInput, #groupFilter {
            padding: 10px; border: 1px solid var(--border-color);
            border-radius: 4px; box-sizing: border-box; font-size: 16px;
            outline: none; transition: border-color 0.3s, box-shadow 0.3s;
            background-color: var(--container-bg-color); width: 100%; margin-bottom: 15px;
        }
        
        input[type="text"]:focus,
        input[type="url"]:focus,
        input[type="number"]:focus,
        textarea:focus,
        select:focus {
            outline: none;
            border-color: var(--button-delete-color);
            box-shadow: 0 0 0 2px rgba(84, 110, 122, 0.25);
        }

        #groupFilter { text-align: center; text-align-last: center; }

        #results { 
            text-align: center; 
        }
        table { 
            width: 100%; 
            margin: 20px auto; 
            table-layout: fixed; 
            border-spacing: 0;
            border-collapse: separate;
            border-radius: 8px;
        }
        th, td { border: 1px solid var(--border-color); padding: 12px; text-align: center; box-sizing: border-box; overflow: hidden; vertical-align: middle; word-wrap: break-word; }
        th { background-color: var(--primary-color); color: white; }
        
        th:first-child { border-top-right-radius: 8px; }
        th:last-child { border-top-left-radius: 8px; }
        tbody tr:last-child td:first-child { border-bottom-right-radius: 8px; }
        tbody tr:last-child td:last-child { border-bottom-left-radius: 8px; }

        tr:nth-child(even) { background-color: var(--row-alt-color); }
        tbody tr { 
            cursor: pointer; 
            -webkit-tap-highlight-color: transparent;
            outline: none;
        } 
        tbody tr.drag-over-indicator {
            background-color: var(--selected-row-color) !important;
        }
        tr.selected { background-color: var(--selected-row-color) !important; }

        body.is-dragging tr.selected {
            background-color: transparent !important;
        }
        body.is-dragging tr:nth-child(even).selected {
            background-color: var(--row-alt-color) !important;
        }

        /* --- START: التعديل على عرض الأعمدة --- */
        table th:nth-child(1), table td:nth-child(1) { width: 15%; min-width: 80px; } /* رقم */
        table th:nth-child(2), table td:nth-child(2) { width: 60%; min-width: 150px;} /* اسم القناة + الصورة */
        table th:nth-child(3), table td:nth-child(3) { width: 25%; min-width: 80px; } /* المجموعة */

        /* إخفاء العمود الرابع (إدارة) بالكامل */
        table th:nth-child(4), table td:nth-child(4) {
            display: none;
        }
        /* --- END: التعديل على عرض الأعمدة --- */
        
        /* --- START: التعديل النهائي لتنسيق خلية اسم القناة --- */
        td.channel-name {
            position: relative; /* نجعل الخلية مرجعًا لمكان الصورة */
            padding-right: 45px; /* نترك مساحة فارغة على اليمين لوضع الصورة فيها */
        }

        td.channel-name img,
        td.channel-name .placeholder {
            position: absolute; /* نجعل الصورة "عائمة" بشكل مطلق داخل الخلية */
            right: 8px; /* نثبتها على بعد 8 بكسل من حافة الخلية اليمنى */
            top: 50%; /* نضعها في منتصف ارتفاع الخلية */
            transform: translateY(-50%); /* نضبط مكانها لتتوسط عموديًا بشكل دقيق */
            width: 30px;
            height: 30px;
            object-fit: contain;
            cursor: pointer; /* تغيير شكل المؤشر للإشارة إلى أنها قابلة للنقر */
        }

        td.channel-name .name-text {
            text-align: center; /* نكتفي بتوسيط النص أفقيًا */
            white-space: normal !important;
            word-break: break-word;
            overflow: hidden;
            direction: ltr;
        }
        /* --- END: التعديل النهائي لتنسيق خلية اسم القناة --- */
        
        td.channel-group { direction: ltr; }


        .action-button-icon { background: none; border: none; cursor: pointer; font-size: 1.2em; margin: 0 1px; padding: 5px 3px; display: inline-block; text-align: center; color: var(--secondary-color); font-weight: bold; transition: color 0.3s; }
        .action-button-icon:hover { color: var(--secondary-hover); }
        .delete-btn-icon { color: var(--button-delete-color); }
        .delete-btn-icon:hover { color: var(--button-delete-hover); }

        .modal-content { background-color: var(--container-bg-color); }
        
        #toastContainer {
            position: fixed;
            top: 20px;
            left: 20px;
            z-index: 2000;
            display: flex;
            flex-direction: column;
            gap: 10px;
            direction: ltr;
        }
        .toast-wrapper {
            opacity: 0;
            transform: translateX(-120%);
            transition: all 0.5s cubic-bezier(0.68, -0.55, 0.27, 1.55);
        }
        .toast-wrapper.show {
            opacity: 1;
            transform: translateX(0);
        }
        .toast {
            display: grid;
            grid-template-columns: 1fr auto auto;
            align-items: center;
            gap: 10px;
            min-width: 300px;
            background-color: #fff;
            color: #333;
            padding: 12px;
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
            border-left: 5px solid #ccc;
            box-sizing: border-box;
        }
        .toast.success { border-left-color: var(--primary-color); }
        .toast.error { border-left-color: var(--delete-color); }
        .toast.info { border-left-color: var(--secondary-color); }
        .toast-content {
            text-align: right;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }
        .toast-close {
            background: none;
            border: none;
            color: #aaa;
            font-size: 20px;
            cursor: pointer;
            padding: 0 5px;
        }
        .toast-close:hover {
            color: #333;
        }
        .toast-action {
            color: var(--primary-color);
            text-decoration: underline;
            cursor: pointer;
            font-weight: bold;
            margin-left: 10px;
        }
        
        #paginationControls { display: flex; justify-content: center; align-items: center; margin-top: 20px; gap: 10px; } 
        #paginationControls button { background-color: #f0f0f0; border: 1px solid var(--border-color); padding: 7.5px 16px; border-radius: 4px; cursor: pointer; }
        #paginationControls button:disabled { background-color: #e9ecef; cursor: not-allowed; } #pageInfo { font-weight: bold; } #confirmModal .modal-content { max-width: 400px; text-align: center; } #confirmMessage { margin: 20px 0; font-size: 1.1em; } 
        /* START: MODIFICATION - Center all modals */
        .modal { 
            display: none; 
            position: fixed; 
            z-index: 1000; 
            left: 0; top: 0; 
            width: 100%; 
            height: 100%; 
            overflow: auto; 
            background-color: rgba(0,0,0,0.4); 
            align-items: center; /* This centers the modal vertically */
            justify-content: center; 
            padding-top: 0; /* Remove previous top padding */
        } 
        /* END: MODIFICATION */

        .modal-content { padding: 20px; border: 1px solid var(--border-color); width: auto; max-width: 500px; border-radius: 10px; position: relative; box-sizing: border-box; overflow-y: auto; max-height: 90vh; margin: auto; } .modal-content textarea { width: 95%; min-height: 150px; padding: 8px; margin: 10px auto; display: block; border: 1px solid var(--border-color); border-radius: 4px; box-sizing: border-box; resize: vertical; } #multiUrlTextarea { direction: ltr; text-align: left; } .close { color: #aaa; float: left; font-size: 28px; font-weight: bold; } .close:hover, .close:focus { color: #000; text-decoration: none; cursor: pointer; } 
        .modal-content input[type="text"], .modal-content input[type="url"], .modal-content input[type="number"], .modal-content select { 
            width: 95%; padding: 8px; margin: 10px 0; display: inline-block; border: 1px solid var(--border-color); border-radius: 4px; box-sizing: border-box; 
            transition: border-color 0.3s, box-shadow 0.3s;
        } 
        .modal-content input[type="radio"], .modal-content input[type="checkbox"] { 
            margin: 10px 5px;
            accent-color: var(--primary-color);
        } 
        .modal-content input[type="radio"]:disabled + label {
            opacity: 0.5;
            cursor: not-allowed;
        }
        .modal-content button {
            background-color: var(--primary-color);
            color: white; border: none;
            padding: 7.5px 20px;
            border-radius: 8px;
            font-weight: bold;
            cursor: pointer;
            margin-left: 3px;
            box-sizing: border-box;
            min-width: 80px;
        }
        .modal-content button.cancel { background-color: var(--button-delete-color); } 
        .modal-content button:hover { opacity: 0.8; } 
        .modal-row { display: flex; align-items: center; margin-bottom: 10px; } 
        .modal-row label { margin-left: 5px; cursor: pointer; } 
        .modal-buttons {
            display: flex;
            justify-content: center;
            align-items: center;
            margin-top: 25px; /* عاد إلى القيمة الأصلية */
            flex-wrap: wrap;
            gap: 10px;
            width: 100%;
        }

        .modal-form-row {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 25px;
        }
        #addModal .modal-content h2,
        #editModal .modal-content h2 {
            width: 100%;
            margin-bottom: 20px;
        }
        .modal-form-row label {
            flex-basis: 90px;
            flex-shrink: 0;
            text-align: right;
        }
        #addModal .modal-form-row input,
        #editModal .modal-form-row input {
            width: 100%;
            margin: 0;
        }
        #addLogoPreview, #logoPreview {
            margin-right: auto;
            padding-left: 5px;
        }

        #duplicate-results-list { margin-top: 15px; }
        .duplicate-group { border: 1px solid var(--border-color); border-radius: 6px; margin-bottom: 10px; padding: 10px; }
        .duplicate-group h4 { margin: 0 0 10px 0; font-size: 1.1em; color: var(--primary-color); }
        .duplicate-channel-item { display: flex; align-items: center; }
        .duplicate-channel-item label { display: flex; align-items: center; padding: 5px; border-radius: 4px; cursor: pointer; width: 100%; }
        .duplicate-channel-item label:hover { background-color: var(--row-alt-color); }
        .duplicate-channel-item input { margin-right: 8px; flex-shrink: 0; }
        .duplicate-channel-item .dup-logo { width: 25px; height: 25px; object-fit: contain; margin-left: 8px; flex-shrink: 0; }
        .duplicate-channel-item .dup-logo-placeholder { width: 25px; text-align: center; margin-left: 8px; flex-shrink: 0; }
        .duplicate-channel-item .dup-info-icon { margin-right: auto; cursor: pointer; color: var(--secondary-color); font-size: 1.2em; padding: 5px; }

        #bulk-actions-list {
            display: flex;
            flex-direction: column;
            gap: 15px;
            padding: 10px 0;
        }
        #bulk-actions-list .modal-row {
            margin-bottom: 0;
            border: 1px solid var(--border-color);
            padding: 10px;
            border-radius: 6px;
            flex-wrap: wrap;
        }
        
        #bulk-move-input-container {
            display: none;
            width: 100%;
            padding-top: 10px;
            margin-top: 10px;
            border-top: 1px solid var(--border-color);
            flex-wrap: nowrap;
            align-items: center;
        }
        #bulk-move-input-container label {
            margin: 0 0 0 8px;
            white-space: nowrap;
        }
        #bulk-move-target-index {
            flex-grow: 1;
            margin: 0;
            padding: 10px 8px;
            font-size: 1em;
            text-align: right;
            width: auto;
        }

        .dropdown-container {
            position: relative;
            display: inline-block;
            width: 100%;
            margin-top: 20px;
            padding-top: 15px;
            border-top: 1px solid var(--border-color);
        }
        #channelCheckerModal .dropdown-btn {
            width: 100%;
            background-color: var(--secondary-color) !important;
            color: white;
            padding: 7.5px 10px;
            font-size: 1em;
            font-weight: bold;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            text-align: center;
            transition: background-color 0.3s;
        }
        #channelCheckerModal .dropdown-btn:hover {
            background-color: var(--secondary-hover) !important;
        }
        .dropdown-content {
            display: none;
            position: absolute;
            background-color: #f9f9f9;
            min-width: 100%;
            box-shadow: 0px 8px 16px 0px rgba(0,0,0,0.2);
            z-index: 1;
            border-radius: 6px;
            overflow: hidden;
            bottom: 100%;
            margin-bottom: 5px;
        }
        .dropdown-content a {
            color: black;
            padding: 12px 16px;
            text-decoration: none;
            display: block;
            text-align: right;
            border-bottom: 1px solid var(--border-color);
        }
        .dropdown-content a:last-child {
            border-bottom: none;
        }
        .dropdown-content a:hover {
            background-color: #f1f1f1;
        }
        .dropdown-content a.delete-option {
            color: var(--delete-color);
            font-weight: bold;
        }
        .dropdown-content a.delete-option:hover {
            background-color: #f5c2bf;
        }
        .show {
            display: block;
        }
        
        /* START: MODIFICATION - Smooth animation for sort modal containers */
        #sortByNameInputContainer, #sortByGroupInputContainer, #moveBlockInputContainer {
            max-height: 0;
            overflow: hidden;
            transition: max-height 0.4s ease-in-out, margin 0.4s ease-in-out;
            margin-right: 25px;
            margin-top: 0;
            margin-bottom: 0;
        }

        #sortByNameInputContainer.visible, #sortByGroupInputContainer.visible {
            max-height: 100px;
            margin-bottom: 10px;
        }
        #moveBlockInputContainer.visible {
            max-height: 200px;
        }
        /* END: MODIFICATION */
        
        /* START: MODIFICATION - Smooth animation for group management modal */
        #renameGroupInputContainer, #mergeGroupInputContainer {
            max-height: 0;
            overflow: hidden;
            transition: all 0.4s ease-in-out;
            margin-right: 25px;
            margin-top: 0;
            margin-bottom: 0;
            padding: 0;
        }
        #renameGroupInputContainer.visible {
            max-height: 150px;
            margin-bottom: 10px;
        }
        #mergeGroupInputContainer.visible {
            max-height: 100px;
            margin-bottom: 10px;
        }
        /* END: MODIFICATION */

        .move-block-row {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 10px;
        }
        .move-block-row label {
            flex-shrink: 0;
        }
        .move-block-row input {
            width: 100px;
        }
        
        .modal-content.compact-layout .modal-row {
            margin-bottom: 2px;
        }
        .modal-content.compact-layout .move-block-row {
            margin-bottom: 4px;
        }
        .modal-content.compact-layout .modal-buttons {
            margin-top: 10px;
        }
        .modal-content.compact-layout #moveBlockInputContainer {
            padding-top: 5px;
            padding-bottom: 5px;
        }


        #loadingIndicator { font-weight: bold; color: var(--primary-color); text-align: center; margin: 20px; } #logoPreview img, #addPreviewImage { max-width: 50px; max-height: 50px; display: none; } #mergeModal .modal-content-body { padding: 15px; text-align: center; } #mergeOptionSelector { width: 100%; padding: 10px; font-size: 1em; margin-bottom: 20px; } .merge-option-container { padding: 10px; } .merge-option-container p { margin-bottom: 20px; color: #666; } 
        .merge-option-container button { background-color: var(--primary-color); color: white; padding: 7.5px 25px; font-size: 1em; border: none; border-radius: 6px; cursor: pointer; }
        .merge-option-container button:hover { background-color: var(--primary-hover); } 
        .status-dot { height: 10px; width: 10px; border-radius: 50%; display: none; margin-left: 5px; } body.show-status-dots .status-dot { display: inline-block; } .status-dot.unchecked { background-color: #bbb; } .status-dot.checking { background-color: #f0ad4e; animation: blinker 1s linear infinite; } .status-dot.checked-ok { background-color: #5cb85c; } .status-dot.checked-fail { background-color: var(--delete-color); } @keyframes blinker { 50% { opacity: 0.5; } } #checker-progress-bar-container { width: 100%; background-color: #f3f3f3; border-radius: 5px; margin: 15px 0; } #checker-progress-bar { width: 0%; height: 20px; background-color: var(--primary-color); border-radius: 5px; text-align: center; line-height: 20px; color: white; transition: width 0.3s; } .find-replace-options div { margin-bottom: 5px; }
        
        @media (max-width: 600px) {
            h1.page-title {
                font-size: 1.9em;
            }
        
            .container {
                padding: 15px;
                margin: 10px auto;
            }
            table {
                font-size: 14px;
            }
            th {
    padding: 6px 3px; /* للحفاظ على ارتفاع صف العناوين الأصلي */
}
td {
    padding: 14px 5px;  /* لزيادة ارتفاع صفوف البيانات فقط */
}
            
            table th:nth-child(2), table td:nth-child(2) { 
                display: table-cell; 
            }

            .modal-content {
                width: 91%;
                padding: 15px;
                margin: auto; /* Ensure margin is auto for centering */
                max-height: 90vh;
            }
            .modal-content input[type="text"],
            .modal-content input[type="url"],
            .modal-content input[type="number"] {
                margin: 5px 0 10px 0;
            }
            .find-replace-options {
                margin-top: 10px !important;
            }
            .find-replace-options p {
                margin-bottom: 2px;
            }
            #bulk-actions-list {
                gap: 8px;
            }
            .modal-buttons {
                margin-top: 15px;
            }
        }
        
        .site-footer {
            text-align: center;
            padding: 20px 20px 30px 20px;
            margin-top: auto;
            color: #888;
            font-size: 0.9em;
            flex-shrink: 0;
        }
        .site-footer a {
            color: var(--button-delete-color);
            text-decoration: none;
            font-weight: bold;
        }
        .site-footer a:hover {
            text-decoration: underline;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1 class="page-title"><a href="">محرر قوائم تشغيل M3U/M3U8</a></h1>
        
        <div id="loadingIndicator" style="display: none;"><p>جارٍ التحميل...</p></div>
        
        <div id="mainControls">
            <label for="fileInput" id="uploadArea" class="upload-area">
                <p style="font-size: 1.1em; font-weight: bold;">اضغط لرفع ملف قائمة التشغيل</p>
                <span class="upload-label">اختيار ملف M3U أو M3U8</span>
            </label>
            
            <div id="urlLoadContainer">
                 <div class="button-row" id="initialButtonsRow">
                    <button class="action-btn" id="loadUrlButton" onclick="openModal('multiUrlModal')">تحميل من روابط</button>
                    <button class="action-btn" id="createNewPlaylistButton" onclick="createNewPlaylist()">إنشاء قائمة جديدة</button>
                 </div>
            </div>

            <div class="button-row" id="saveAddRow">
                <button class="action-btn" id="openExportModalButton" onclick="openModal('exportModal')">تصدير القائمة</button>
                <button class="action-btn" id="addChannelButton" onclick="openAddModal()">إضافة قناة</button>
            </div>
            
            <div class="button-row" id="toolsMergeRow">
                <button class="action-btn" id="openSortModalButton" onclick="openSortModal()">فرز وترتيب</button>
                <button class="action-btn" id="manageGroupsButton" onclick="openManageGroupsModal()">إدارة المجموعات</button>
                <button class="action-btn" id="openMergeModalButton" onclick="openMergeModal()">دمج قوائم</button>
                <button class="action-btn" id="removeDuplicatesButton" onclick="removeDuplicatesManually()">إزالة التكرار</button>
                <button class="action-btn" id="openChannelCheckerButton" onclick="openChannelCheckerModal()">فحص حالة القنوات</button>
                <button class="action-btn" id="openFindReplaceButton" onclick="openFindReplaceModal()">بحث واستبدال</button>
                <button class="action-btn" id="openSearchFilterModalButton" onclick="openModal('searchFilterModal')">بحث وتصفية</button>
                <button class="action-btn" id="bulkActionsButton" onclick="openModal('bulkActionsModal')">إجراءات على المحدد</button>
            </div>
        </div>

        <input type="file" id="fileInput" accept=".m3u,.m3u8,.pls" multiple style="display: none;">
        <input type="file" id="mergeFileInput" accept=".m3u,.m3u8,.pls" multiple style="display: none;">
        <div id="results"></div>
        <div id="paginationControls"></div>
    </div>

    <!-- All Modals -->
    <div id="searchFilterModal" class="modal"><div class="modal-content"><span class="close" onclick="closeModal('searchFilterModal')">&times;</span><h2>بحث وتصفية القنوات</h2><input type="text" id="searchInput" placeholder="ابحث عن قناة..."><select id="groupFilter"><option value="all">كل المجموعات</option></select><div class="modal-buttons"><button id="searchFilterActionButton">إغلاق</button></div></div></div>
    
    <div id="bulkActionsModal" class="modal">
        <div class="modal-content">
            <span class="close" onclick="closeModal('bulkActionsModal')">&times;</span>
            <h2>إجراءات على القنوات المحددة</h2>
            <div id="bulk-actions-list">
                <div class="modal-row">
                    <input type="radio" id="bulk-action-sort" name="bulkAction" value="sort" checked>
                    <label for="bulk-action-sort">فرز المحدد أبجدياً</label>
                </div>
                <div class="modal-row">
                    <input type="radio" id="bulk-action-move" name="bulkAction" value="move">
                    <label for="bulk-action-move">نقل المحدد إلى موضع</label>
                    <div id="bulk-move-input-container">
                        <label for="bulk-move-target-index">رقم:</label>
                        <input type="number" id="bulk-move-target-index" min="1" placeholder="مثال: 1">
                    </div>
                </div>
                <div class="modal-row">
                    <input type="radio" id="bulk-action-group" name="bulkAction" value="group">
                    <label for="bulk-action-group">تعديل المجموعة</label>
                </div>
                <div class="modal-row">
                    <input type="radio" id="bulk-action-remove-group" name="bulkAction" value="removeGroup">
                    <label for="bulk-action-remove-group">إزالة التصنيف عن المحدد</label>
                </div>
                <div class="modal-row">
                    <input type="radio" id="bulk-action-delete" name="bulkAction" value="delete">
                    <label for="bulk-action-delete">حذف المحدد</label>
                </div>
                <div class="modal-row">
                    <input type="radio" id="bulk-action-export" name="bulkAction" value="export">
                    <label for="bulk-action-export">تصدير المحدد</label>
                </div>
            </div>
            <div class="modal-buttons">
                <button onclick="executeBulkAction()">تنفيذ</button>
                <button onclick="closeModal('bulkActionsModal')" class="cancel">إلغاء</button>
            </div>
        </div>
    </div>
    
    <div id="channelCheckerModal" class="modal"><div class="modal-content"><span class="close" onclick="closeModal('channelCheckerModal')">&times;</span><h2>مدقق حالة القنوات</h2><p>سيقوم هذا الإجراء بالتحقق من كل قناة لتحديد ما إذا كانت تعمل. قد يستغرق هذا بعض الوقت للقوائم الكبيرة.</p><div id="checker-progress-container"><p id="checker-progress-text">اضغط على زر 'بدء الفحص' للتحقق من حالة القنوات.</p><div id="checker-progress-bar-container"><div id="checker-progress-bar">0%</div></div></div><p id="checker-summary-text" style="font-weight: bold;"></p><div class="modal-buttons"><button id="start-check-btn" onclick="executeChannelCheck()">بدء الفحص</button><button id="stop-check-btn" onclick="stopChannelCheck()" class="cancel" style="display:none;">إيقاف الفحص</button><button id="checker-cancel-btn" onclick="closeModal('channelCheckerModal')" class="cancel">إغلاق</button></div><div class="dropdown-container" id="checker-actions-container" style="display: none;"><button onclick="toggleCheckerActions()" class="dropdown-btn">إجراءات &#9662;</button><div id="checker-actions-dropdown" class="dropdown-content"><a href="#" id="export-working-btn" onclick="exportWorkingChannels()">تصدير القنوات التي تعمل</a><a href="#" id="select-failed-btn" onclick="selectFailedChannels()">تحديد القنوات التي لا تعمل</a><a href="#" id="delete-failed-btn" class="delete-option" onclick="deleteFailedChannels()">حذف القنوات التي لا تعمل</a></div></div></div></div>

    <div id="findReplaceModal" class="modal"><div class="modal-content"><span class="close" onclick="closeModal('findReplaceModal')">&times;</span><h2>بحث واستبدال</h2>
        <div class="find-replace-options" style="margin-bottom: 15px;">
            <label for="replace-scope-selector" style="display:block; margin-bottom: 5px;"><strong>النطاق:</strong></label>
            <select id="replace-scope-selector" style="width: 95%;"></select>
        </div>
        <label for="find-text">بحث عن:</label><input type="text" id="find-text">
        <label for="replace-text">استبدال بـ:</label><input type="text" id="replace-text">
        <div class="find-replace-options"><p style="margin-top: 15px; margin-bottom: 5px;"><strong>بحث في:</strong></p>
            <div><input type="checkbox" id="find-in-name" checked> <label for="find-in-name">اسم القناة</label></div>
            <div><input type="checkbox" id="find-in-group"> <label for="find-in-group">المجموعة</label></div>
            <div><input type="checkbox" id="find-in-url"> <label for="find-in-url">رابط التشغيل</label></div>
        </div>
        <div class="modal-buttons"><button onclick="executeFindAndReplace()">تنفيذ</button><button onclick="closeModal('findReplaceModal')" class="cancel">إلغاء</button></div>
    </div></div>

    <div id="multiUrlModal" class="modal"><div class="modal-content"><span class="close" onclick="closeModal('multiUrlModal')">&times;</span><h2>تحميل من عدة روابط</h2><p>ألصق الروابط هنا، كل رابط في سطر جديد. سيتم دمجها بالترتيب.</p><textarea id="multiUrlTextarea" placeholder="https://example.com/playlist1.m3u&#10;https://example.com/playlist2.m3u8"></textarea><div class="modal-buttons"><button onclick="processMultiUrlLoad()">تحميل</button><button onclick="closeModal('multiUrlModal')" class="cancel">إلغاء</button></div></div></div>
    <div id="bulkEditGroupModal" class="modal"><div class="modal-content"><span class="close" onclick="closeModal('bulkEditGroupModal')">&times;</span><h2>تعديل مجموعة القنوات المحددة</h2><label for="bulkNewGroupName">اسم المجموعة الجديد:</label><input type="text" id="bulkNewGroupName" placeholder="أدخل اسمًا جديدًا أو اتركه فارغًا"><div class="modal-buttons"><button onclick="executeBulkEditGroup()">تطبيق</button><button onclick="closeModal('bulkEditGroupModal')" class="cancel">إلغاء</button></div></div></div>

    <div id="editModal" class="modal">
        <div class="modal-content">
            <span class="close" onclick="closeModal('editModal')">&times;</span>
            <h2>تحرير القناة</h2>
            <div class="modal-form-row">
                <label for="editIndexField">رقم القناة:</label>
                <input type="number" id="editIndexField" min="1">
            </div>
            <div class="modal-form-row">
                <label for="editName">اسم القناة:</label>
                <input type="text" id="editName">
            </div>
            <div class="modal-form-row">
                <label for="editGroup">المجموعة:</label>
                <input type="text" id="editGroup">
            </div>
            <div class="modal-form-row">
                <label for="editLogo">رابط الصورة:</label>
                <input type="url" id="editLogo">
                <div id="logoPreview"><img id="previewImage"></div>
            </div>
            <div class="modal-form-row">
                <label for="editUrl">رابط التشغيل:</label>
                <input type="url" id="editUrl">
            </div>
            <input type="hidden" id="editOriginalIndex">
            <div class="modal-buttons">
                <button onclick="saveEdit()">حفظ</button>
                <button onclick="closeModal('editModal')" class="cancel">إلغاء</button>
            </div>
        </div>
    </div>

    <div id="addModal" class="modal">
        <div class="modal-content">
            <span class="close" onclick="closeModal('addModal')">&times;</span>
            <h2>إضافة قناة جديدة</h2>
            <div class="modal-form-row">
                <label for="addIndexField">رقم القناة:</label>
                <input type="number" id="addIndexField" min="1">
            </div>
            <div class="modal-form-row">
                <label for="addName">اسم القناة:</label>
                <input type="text" id="addName" required>
            </div>
            <div class="modal-form-row">
                <label for="addGroup">المجموعة:</label>
                <input type="text" id="addGroup">
            </div>
            <div class="modal-form-row">
                <label for="addLogo">رابط الصورة:</label>
                <input type="url" id="addLogo">
                <div id="addLogoPreview"><img id="addPreviewImage"></div>
            </div>
            <div class="modal-form-row">
                <label for="addUrl">رابط التشغيل:</label>
                <input type="url" id="addUrl" required>
            </div>
            <div class="modal-buttons">
                <button onclick="saveNewChannel()">إضافة</button>
                <button onclick="closeModal('addModal')" class="cancel">إلغاء</button>
            </div>
        </div>
    </div>
    
    <div id="removeDuplicatesModal" class="modal">
        <div class="modal-content">
            <span class="close" onclick="closeModal('removeDuplicatesModal')">&times;</span>
            <h2>إزالة التكرار</h2>
            <div id="duplicate-criteria-step">
                <label>اختر الشرط:</label>
                <div class="modal-row"><input type="radio" id="crit-name" name="duplicateCriteria" value="name"><label for="crit-name">الاسم فقط</label></div>
                <div class="modal-row"><input type="radio" id="crit-name-url" name="duplicateCriteria" value="name-url" checked><label for="crit-name-url">الاسم + الرابط</label></div>
                <div class="modal-row"><input type="radio" id="crit-name-url-group" name="duplicateCriteria" value="name-url-group"><label for="crit-name-url-group">الاسم + الرابط + المجموعة</label></div>
                <div class="modal-buttons">
                    <button onclick="findDuplicates()">البحث عن التكرار</button>
                    <button onclick="closeModal('removeDuplicatesModal')" class="cancel">إلغاء</button>
                </div>
            </div>
            <div id="duplicate-results-step" style="display: none;">
                 <p><strong>اختر النسخة التي تريد الإبقاء عليها:</strong></p>
                <div id="duplicate-results-list"></div>
                <div class="modal-buttons">
                    <button onclick="executeDuplicateDeletion()">حذف التكرار</button>
                    <button onclick="showDuplicateCriteriaStep()" class="cancel">رجوع</button>
                </div>
            </div>
        </div>
    </div>
    
    <div id="sortModal" class="modal"><div class="modal-content">
        <span class="close" onclick="closeModal('sortModal')">&times;</span>
        <h2>فرز وترتيب القنوات</h2>
        <div id="sort-scope-container" style="display: none; margin-bottom: 15px;">
            <label for="sort-scope-selector" style="display:block; margin-bottom: 5px;"><strong>نطاق الفرز:</strong></label>
            <select id="sort-scope-selector" style="width: 95%;"></select>
        </div>
        <div class="modal-row"><input type="radio" id="sort-alpha" name="sortCriteria" value="alphabetical" checked onchange="handleSortCriteriaChange()"><label for="sort-alpha">أبجدي</label></div>
        <div class="modal-row"><input type="radio" id="sort-chno" name="sortCriteria" value="tvg-chno" onchange="handleSortCriteriaChange()"><label for="sort-chno">حسب الرقم الأصلي (tvg-chno)</label></div>
        <div class="modal-row"><input type="radio" id="sort-name" name="sortCriteria" value="name" onchange="handleSortCriteriaChange()"><label for="sort-name">حسب اسم القناة</label></div>
        <div id="sortByNameInputContainer"><input type="text" id="sortByNameField" placeholder="أدخل اسم القناة (مثال: mbc)"></div>
        <div class="modal-row"><input type="radio" id="sort-group" name="sortCriteria" value="group" onchange="handleSortCriteriaChange()"><label for="sort-group">حسب اسم المجموعة</label></div>
        <div id="sortByGroupInputContainer"><input type="text" id="sortByGroupField" placeholder="أدخل اسم المجموعة"></div>
        <div class="modal-row" id="sort-move-row">
            <input type="radio" id="sort-move" name="sortCriteria" value="moveBlock" onchange="handleSortCriteriaChange()">
            <label for="sort-move">نقل مجموعة قنوات إلى موضع جديد</label>
        </div>
        <div id="moveBlockInputContainer">
            <div class="move-block-row">
                <label for="moveFromIndex">نقل من رقم:</label>
                <input type="number" id="moveFromIndex" min="1" placeholder="مثال: 50">
            </div>
            <div class="move-block-row">
                <label for="moveToIndex">إلى رقم:</label>
                <input type="number" id="moveToIndex" min="1" placeholder="مثال: 100">
            </div>
             <div class="move-block-row">
                <label for="moveTargetIndex">إلى الموضع رقم:</label>
                <input type="number" id="moveTargetIndex" min="1" placeholder="مثال: 1">
            </div>
        </div>
        <div class="modal-row" style="margin-top: 15px; padding-top: 10px; border-top: 1px solid var(--border-color);">
            <input type="checkbox" id="sort-descending">
            <label for="sort-descending">ترتيب تنازلي</label>
        </div>
        <div class="modal-buttons"><button onclick="executeSort()">تنفيذ</button><button onclick="closeModal('sortModal')" class="cancel">إلغاء</button></div>
    </div></div>
    
    <div id="manageGroupsModal" class="modal"><div class="modal-content">
        <span class="close" onclick="closeModal('manageGroupsModal')">&times;</span>
        <h2>إدارة المجموعات</h2>
        <!-- START: MODIFICATION - Removed inline styles that caused scrolling -->
        <div style="padding: 5px; margin: 0 -5px 15px -5px;">
        <!-- END: MODIFICATION -->
            <label for="groupSelector">اختر المجموعة:</label>
            <select id="groupSelector" onchange="handleGroupSelectorChange()"></select>
            <label>اختر الإجراء:</label>
            <div class="modal-row">
                <input type="radio" id="action-rename" name="groupAction" value="rename" checked onchange="handleGroupActionChange()">
                <label for="action-rename">إعادة تسمية</label>
            </div>
            <div id="renameGroupInputContainer">
                <input type="text" id="newGroupNameField" placeholder="أدخل اسمًا جديدًا أو اتركه فارغًا">
                <div class="modal-row" style="font-size: 0.9em; margin-top: 5px;">
                    <input type="checkbox" id="rename-add-as-new">
                    <label for="rename-add-as-new">إضافة دون حذف التصنيفات الحالية</label>
                </div>
            </div>
            <div class="modal-row">
                <input type="radio" id="action-merge" name="groupAction" value="merge" onchange="handleGroupActionChange()">
                <label for="action-merge">دمج المجموعة المحددة</label>
            </div>
            <div id="mergeGroupInputContainer">
                <label for="mergeTargetSelector" style="display: block;">مع المجموعة:</label>
                <select id="mergeTargetSelector"></select>
            </div>
            <div class="modal-row">
                <input type="radio" id="action-remove-all-groups" name="groupAction" value="removeAll" onchange="handleGroupActionChange()">
                <label for="action-remove-all-groups">إزالة كل التصنيفات</label>
            </div>
            <div class="modal-row">
                <input type="radio" id="action-delete" name="groupAction" value="delete" onchange="handleGroupActionChange()">
                <label for="action-delete">حذف المجموعة</label>
            </div>
            <div class="modal-row">
                <input type="radio" id="action-export-group" name="groupAction" value="exportGroup" onchange="handleGroupActionChange()">
                <label for="action-export-group">تصدير قنوات المجموعة</label>
            </div>
        </div>
        <div class="modal-buttons">
            <button onclick="executeGroupAction()">تنفيذ</button>
            <button onclick="closeModal('manageGroupsModal')" class="cancel">إلغاء</button>
        </div>
    </div></div>
    
    <div id="mergeModal" class="modal"><div class="modal-content"><span class="close" onclick="closeModal('mergeModal')">&times;</span><h2>خيارات الدمج</h2>
        <div class="modal-content-body">
            <label for="mergeOptionSelector" style="display:block; margin-bottom: 5px; text-align: right;">اختر طريقة الدمج:</label>
            <select id="mergeOptionSelector" onchange="handleMergeOptionChange()">
                <option value="file" selected>من ملف</option>
                <option value="url">من رابط</option>
            </select>
            <div id="mergeFileOption" class="merge-option-container" style="display: block;">
                <p>اختر ملف أو أكثر لدمجه مع القائمة الحالية.</p>
                <button onclick="document.getElementById('mergeFileInput').click()">اختيار ملفات</button>
            </div>
            <div id="mergeUrlOption" class="merge-option-container" style="display: none;">
                <p>ألصق الروابط هنا، كل رابط في سطر جديد.</p>
                <textarea id="mergeUrlTextarea" placeholder="https://example.com/playlist.m3u" style="width: 100%; min-height: 120px; margin-bottom: 20px; direction: ltr; text-align: left;"></textarea>
                <button onclick="executeMerge()">دمج الروابط</button>
            </div>
        </div>
    </div></div>

    <div id="exportModal" class="modal"><div class="modal-content"><span class="close" onclick="closeModal('exportModal')">&times;</span><h2>تصدير قائمة التشغيل</h2><p>اختر الصيغة المطلوبة للحفظ:</p><div class="modal-row"><input type="radio" id="export-m3u" name="exportFormat" value="m3u" checked><label for="export-m3u">M3U</label></div><div class="modal-row"><input type="radio" id="export-m3u8" name="exportFormat" value="m3u8"><label for="export-m3u8">M3U8</label></div><div class="modal-row"><input type="radio" id="export-pls" name="exportFormat" value="pls"><label for="export-pls">PLS</label></div><div class="modal-row"><input type="radio" id="export-enigma2" name="exportFormat" value="enigma2"><label for="export-enigma2">Enigma2</label></div><div class="modal-buttons"><button onclick="executeExport()">تصدير</button><button onclick="closeModal('exportModal')" class="cancel">إلغاء</button></div></div></div>
    <div id="confirmModal" class="modal"><div class="modal-content"><span class="close" onclick="closeModal('confirmModal')">&times;</span><h2 id="confirmTitle">تأكيد الإجراء</h2><p id="confirmMessage">هل أنت متأكد؟</p><div class="modal-buttons"><button id="confirmBtn" class="action-btn">تأكيد</button><button onclick="closeModal('confirmModal')" class="action-btn delete-btn">إلغاء</button></div></div></div>
    <div id="toastContainer"></div>
    
    <footer class="site-footer">
        <p>تم التطوير بواسطة <a href="https://github.com/iofahmawi" target="_blank" rel="noopener noreferrer">iofahmawi</a></p>
    </footer>

    <script>
        let channelsData = []; let displayedChannels = []; let isMerged = false, isSorted = false; let draggedIndices = []; let selectedIndices = new Set(); let currentPage = 1; const rowsPerPage = 100; let isChecking = false; let isFilterActiveForButton = false;
        
        function openModal(modalId) {
            const modal = document.getElementById(modalId);
            if (modal) {
                modal.style.zIndex = '1000'; // Reset z-index
                modal.style.display = 'flex';
            }
            
            if (modalId === 'searchFilterModal') {
                setupSearchFilterModal();
            } else if (modalId === 'bulkActionsModal') {
                document.querySelectorAll('input[name="bulkAction"]').forEach(radio => {
                    radio.onchange = handleBulkActionChange;
                });
                handleBulkActionChange();
            } else if (modalId === 'removeDuplicatesModal') {
                showDuplicateCriteriaStep();
            }
        }

        function closeModal(modalId) { 
            if(modalId === 'channelCheckerModal' && isChecking) { stopChannelCheck(); } 
            const modal = document.getElementById(modalId); 
            if(modal) modal.style.display = 'none'; 
            
            if (modalId === 'editModal' && document.getElementById('removeDuplicatesModal').style.display === 'flex') {
                document.getElementById('removeDuplicatesModal').style.zIndex = '1000';
            }
        }

        function handleDragStart(e) {
            e.currentTarget.style.cursor = 'grabbing';
            const startIndex = parseInt(e.currentTarget.dataset.index);
            if (selectedIndices.has(startIndex)) {
                draggedIndices = Array.from(selectedIndices).sort((a, b) => a - b);
            } else {
                selectedIndices.clear();
                selectedIndices.add(startIndex);
                document.querySelectorAll('tr.selected').forEach(row => row.classList.remove('selected'));
                e.currentTarget.classList.add('selected');
                updateBulkActionsUI();
            }
            draggedIndices = Array.from(selectedIndices).sort((a, b) => a - b);
            
            document.body.classList.add('is-dragging');
        }

        function handleDragEnd(e) {
            document.body.classList.remove('is-dragging');
        }
        
        function handleDragEnter(e) { e.preventDefault(); const targetRow = e.currentTarget; const targetIndex = parseInt(targetRow.dataset.index); if (!draggedIndices.includes(targetIndex)) { targetRow.classList.add('drag-over-indicator'); } }
        function handleDragLeave(e) { e.currentTarget.classList.remove('drag-over-indicator'); }
        function handleDragOver(e) { e.preventDefault(); }
        
        function handleDrop(e) {
            e.preventDefault();
            const dropTargetRow = e.currentTarget;
            dropTargetRow.classList.remove('drag-over-indicator');

            const dropIndex = parseInt(dropTargetRow.dataset.index);

            if (draggedIndices.length === 0 || draggedIndices.includes(dropIndex)) {
                draggedIndices = [];
                return;
            }

            const isDraggingDown = draggedIndices[0] < dropIndex;
            const draggedItems = draggedIndices.map(index => channelsData[index]);
            const remainingChannels = channelsData.filter(channel => !draggedItems.includes(channel));

            const dropTargetChannel = channelsData[dropIndex];
            let newDropIndex = remainingChannels.indexOf(dropTargetChannel);

            if (isDraggingDown && newDropIndex !== -1) {
                newDropIndex++;
            }

            if (newDropIndex === -1) {
                newDropIndex = remainingChannels.length;
            }

            remainingChannels.splice(newDropIndex, 0, ...draggedItems);

            channelsData = remainingChannels;
            
            draggedIndices = [];
            selectedIndices.clear();
            updateBulkActionsUI();
            updateTvgChnoInAllChannels();
            searchChannels();
            showToast(`تم نقل القنوات بنجاح`, 'success');
        }


        document.addEventListener('DOMContentLoaded', () => { document.getElementById('uploadArea').style.display = 'block'; document.getElementById('urlLoadContainer').style.display = 'block'; document.getElementById('saveAddRow').style.display = 'none'; document.getElementById('toolsMergeRow').style.display = 'none'; ['openExportModalButton', 'addChannelButton', 'openSortModalButton', 'manageGroupsButton', 'openMergeModalButton', 'removeDuplicatesButton', 'bulkActionsButton'].forEach(id => { const button = document.getElementById(id); if (button) button.style.display = 'none'; }); document.getElementById('results').innerHTML = ''; });
        document.getElementById('fileInput').addEventListener('change', handleFileSelect);
        document.getElementById('mergeFileInput').addEventListener('change', mergePlaylists);
        
        function showToast(message, type = 'info', duration = 6000, action = null) {
            const container = document.getElementById('toastContainer');
            const toastWrapper = document.createElement('div');
            toastWrapper.className = 'toast-wrapper';
            const toast = document.createElement('div');
            toast.className = `toast ${type}`;
            const cleanMessage = message.trim().replace(/\.$/, '');
            
            let contentHTML = `<div class="toast-content">${cleanMessage}</div>`;
            if (action) {
                const actionId = `toast-action-${Date.now()}`;
                contentHTML += `<span id="${actionId}" class="toast-action">${action.text}</span>`;
            }
            contentHTML += `<button class="toast-close">&times;</button>`;
            toast.innerHTML = contentHTML;

            toastWrapper.appendChild(toast);
            container.appendChild(toastWrapper);

            const removeToast = () => {
                toastWrapper.classList.remove('show');
                setTimeout(() => {
                    if (container.contains(toastWrapper)) container.removeChild(toastWrapper);
                }, 500);
            };

            if (action) {
                const actionButton = toast.querySelector('.toast-action');
                if (actionButton) {
                    actionButton.onclick = (e) => {
                        e.stopPropagation();
                        action.callback();
                        removeToast();
                    };
                }
            }
            
            const closeButton = toast.querySelector('.toast-close');
            closeButton.onclick = removeToast;
            setTimeout(() => toastWrapper.classList.add('show'), 10);
            if(duration !== -1) {
                setTimeout(removeToast, duration);
            }
        }


        function showConfirm(title, message, onConfirm) { document.getElementById('confirmTitle').textContent = title; document.getElementById('confirmMessage').textContent = message; const confirmBtn = document.getElementById('confirmBtn'); const newConfirmBtn = confirmBtn.cloneNode(true); confirmBtn.parentNode.replaceChild(newConfirmBtn, confirmBtn); newConfirmBtn.onclick = () => { onConfirm(); closeModal('confirmModal'); }; openModal('confirmModal'); }
        function handleRowClick(event) { const row = event.currentTarget; if (event.target.closest('img, .placeholder')) return; const index = parseInt(row.dataset.index); if (selectedIndices.has(index)) { selectedIndices.delete(index); row.classList.remove('selected'); } else { selectedIndices.add(index); row.classList.add('selected'); } updateBulkActionsUI(); }
        
        function updateBulkActionsUI() {
            const bulkActionsButton = document.getElementById('bulkActionsButton');
            const count = selectedIndices.size;
            bulkActionsButton.disabled = count === 0;
        }

        function deleteSelected() { const count = selectedIndices.size; if (count === 0) return; showConfirm('تأكيد الحذف', `هل أنت متأكد من حذف ${count} قناة؟ لا يمكن التراجع عن هذا الإجراء.`, () => { const indicesToDelete = Array.from(selectedIndices).sort((a, b) => b - a); indicesToDelete.forEach(index => { channelsData.splice(index, 1); }); selectedIndices.clear(); updateTvgChnoInAllChannels(); searchChannels(); showToast(`تم حذف ${count} قناة بنجاح`, 'success'); }); }
        
        async function handleFileSelect(event) {
            document.body.classList.remove('show-status-dots');
            const files = event.target.files;
            if (files.length === 0) return;

            const allowedExtensions = /\.(m3u|m3u8|pls)$/i;
            const validFiles = Array.from(files).filter(file => allowedExtensions.test(file.name));
            
            if (validFiles.length === 0) {
                return showToast("يرجى اختيار ملفات بامتداد M3U, M3U8, أو PLS", "error");
            }
            
            document.getElementById('loadingIndicator').style.display = 'block';
            
            try {
                const fileContents = await Promise.all(validFiles.map(file => file.text()));
                const allNewChannels = fileContents.map(content => parsePlaylist(content)).flat();

                if (allNewChannels.length > 0) {
                    channelsData = []; // Start fresh
                    processNewChannels(allNewChannels, `تم استيراد ${allNewChannels.length} قناة من ${validFiles.length} ملفات.`);
                    showPlaylistControls();
                } else {
                    showToast("الملفات المختارة لا تحتوي على قنوات صالحة.", "error");
                }
            } catch (error) {
                console.error("Error reading files:", error);
                showToast("حدث خطأ أثناء قراءة الملفات.", "error");
            } finally {
                document.getElementById('loadingIndicator').style.display = 'none';
                event.target.value = '';
            }
        }


        function displayPaginatedChannels() { const totalPages = Math.ceil(displayedChannels.length / rowsPerPage); currentPage = Math.max(1, Math.min(currentPage, totalPages)); const startIndex = (currentPage - 1) * rowsPerPage; const endIndex = startIndex + rowsPerPage; const pagedChannels = displayedChannels.slice(startIndex, endIndex); renderTable(pagedChannels, startIndex); setupPaginationControls(totalPages); updateBulkActionsUI(); }
        
        function renderTable(channels, startIndex) { 
            const resultsDiv = document.getElementById('results'); 
            resultsDiv.innerHTML = ''; 
            if (channelsData.length === 0) { 
                resultsDiv.innerHTML = '<p>القائمة فارغة. أضف قناة أو قم بتحميل ملف.</p>'; 
                return; 
            } 
            if (channels.length === 0) { 
                resultsDiv.innerHTML = '<p>لا توجد نتائج مطابقة للبحث.</p>'; 
                return; 
            } 
            const table = document.createElement('table'); 
            const tbody = document.createElement('tbody'); 
            
            table.innerHTML = `<thead><tr><th>رقم</th><th>اسم القناة</th><th>المجموعة</th></tr></thead>`; 
            
            channels.forEach((channel, index) => { 
                const originalIndex = channelsData.indexOf(channel); 
                const row = tbody.insertRow(); 
                row.setAttribute('draggable', 'true'); 
                row.dataset.index = originalIndex; 
                if (selectedIndices.has(originalIndex)) { 
                    row.classList.add('selected'); 
                } 
                
                const groupsDisplay = channel.groups && channel.groups.length > 0 ? channel.groups.join(', ') : 'غير مصنفة'; 
                
                const logoHtml = `
                    ${channel.logo ? `<img src="${channel.logo}" alt="Logo" onclick="event.stopPropagation(); openEditModal(${originalIndex});" onerror="this.style.display='none'; this.nextElementSibling.style.display='block';">` : ''}
                    <span class="placeholder" style="${channel.logo ? 'display:none;' : ''}" onclick="event.stopPropagation(); openEditModal(${originalIndex});">📺</span>
                `;
                
                row.innerHTML = `
                    <td>
                        <span class="status-dot ${channel.status || 'unchecked'}" data-index="${originalIndex}"></span>
                        ${startIndex + index + 1}
                    </td>
                    <td class="channel-name">
                        ${logoHtml}
                        <span class="name-text">${channel.name || ''}</span>
                    </td>
                    <td class="channel-group">${groupsDisplay}</td>
                `;
                
                row.addEventListener('click', handleRowClick);
                row.addEventListener('dragstart', handleDragStart);
                row.addEventListener('dragend', handleDragEnd);
                row.addEventListener('dragenter', handleDragEnter);
                row.addEventListener('dragleave', handleDragLeave);
                row.addEventListener('dragover', handleDragOver);
                row.addEventListener('drop', handleDrop);
            }); 
            table.appendChild(tbody); 
            resultsDiv.appendChild(table); 
        }

        function setupPaginationControls(totalPages) { const container = document.getElementById('paginationControls'); container.innerHTML = ''; if (totalPages <= 1) return; container.innerHTML = `<button id="prevPage" onclick="changePage(-1)" ${currentPage === 1 ? 'disabled' : ''}>السابق</button><span id="pageInfo">صفحة ${currentPage} من ${totalPages}</span><button id="nextPage" onclick="changePage(1)" ${currentPage === totalPages ? 'disabled' : ''}>التالي</button>`; }
        function changePage(direction) { currentPage += direction; displayPaginatedChannels(); }
        function searchChannels() { const searchTerm = document.getElementById('searchInput').value.toLowerCase(); const selectedGroup = document.getElementById('groupFilter').value; let tempChannels = channelsData; if (selectedGroup !== 'all') { tempChannels = channelsData.filter(ch => { if (selectedGroup === 'uncategorized') { return !ch.groups || ch.groups.length === 0; } return ch.groups && ch.groups.includes(selectedGroup); }); } if (searchTerm) { displayedChannels = tempChannels.filter(ch => (ch.name || '').toLowerCase().includes(searchTerm) || (ch.groups && ch.groups.join(' ').toLowerCase().includes(searchTerm))); } else { displayedChannels = [...tempChannels]; } currentPage = 1; isFilterActiveForButton = (searchTerm !== '' || selectedGroup !== 'all'); displayPaginatedChannels(); }
        function populateGroupFilter(targetSelectId = 'groupFilter') {
            const groupFilter = document.getElementById(targetSelectId);
            const savedValue = groupFilter.value;
            groupFilter.innerHTML = '<option value="all">كل المجموعات</option>';
            const allGroups = channelsData.flatMap(ch => (ch.groups && ch.groups.length) ? ch.groups : []);
            const hasUncategorized = channelsData.some(ch => !ch.groups || ch.groups.length === 0);
            const uniqueGroups = [...new Set(allGroups)];
            uniqueGroups.sort((a, b) => a.localeCompare(b, 'ar')).forEach(group => {
                const option = document.createElement('option');
                option.value = group;
                option.textContent = group;
                groupFilter.appendChild(option);
            });
            if (hasUncategorized) {
                const option = document.createElement('option');
                option.value = 'uncategorized';
                option.textContent = 'غير مصنفة';
                groupFilter.appendChild(option);
            }
            if (Array.from(groupFilter.options).some(opt => opt.value === savedValue)) {
                groupFilter.value = savedValue;
            }
        }

        function parseM3uPlaylist(content) { const lines = content.split('\n'); const channels = []; let currentInfo = ''; for (const line of lines) { const trimmedLine = line.trim(); if (trimmedLine.startsWith('#EXTINF')) { currentInfo = trimmedLine; } else if (currentInfo && !trimmedLine.startsWith('#') && trimmedLine.length > 0) { const name = currentInfo.match(/,([^,]*)$/)?.[1].trim() || 'قناة غير معروفة'; const logo = currentInfo.match(/tvg-logo="([^"]*)"/i)?.[1] || ''; const chno = parseInt(currentInfo.match(/tvg-chno="([^"]*)"/i)?.[1]) || 0; const groupString = currentInfo.match(/group-title="([^"]*)"/i)?.[1] || ''; const groups = groupString ? groupString.split(';').map(g => g.trim()).filter(g => g) : []; channels.push({ name, groups, logo, chno, url: trimmedLine, originalExtinf: currentInfo, status: 'unchecked' }); currentInfo = ''; } } return channels; }
        
        function parsePlsPlaylist(content) {
            const lines = content.split('\n');
            const channels = [];
            const channelsMap = {};
            const regex = /^(File|Title)(\d+)=(.+)$/i;

            lines.forEach(line => {
                const match = line.match(regex);
                if (match) {
                    const key = match[1].toLowerCase();
                    const index = match[2];
                    const value = match[3].trim();
                    if (!channelsMap[index]) {
                        channelsMap[index] = {};
                    }
                    channelsMap[index][key] = value;
                }
            });

            for (const index in channelsMap) {
                const entry = channelsMap[index];
                if (entry.file && entry.title) {
                    channels.push({
                        name: entry.title,
                        url: entry.file,
                        groups: [],
                        logo: '',
                        chno: 0,
                        originalExtinf: '',
                        status: 'unchecked'
                    });
                }
            }
            return channels;
        }

        function parsePlaylist(content) {
            if (content.trim().toLowerCase().startsWith('[playlist]')) {
                return parsePlsPlaylist(content);
            }
            return parseM3uPlaylist(content);
        }

        function processNewChannels(newChannels, successMessage) {
            const isInitialLoad = channelsData.length === 0;
            const preMergeLength = channelsData.length;
            channelsData.push(...newChannels);

            let duplicatesFound = 0;
            if (!isInitialLoad || newChannels.length > preMergeLength) {
                const seen = new Set();
                let uniqueCount = 0;
                const tempChannels = isInitialLoad ? newChannels : channelsData;
                tempChannels.forEach(channel => {
                    const key = `${(channel.name || '').trim()}-${(channel.url || '').trim()}`;
                    if (!seen.has(key)) {
                        seen.add(key);
                        uniqueCount++;
                    }
                });
                duplicatesFound = tempChannels.length - seen.size;
            }
            
            showToast(successMessage, 'success');

            if (duplicatesFound > 0) {
                const action = {
                    text: 'إزالة التكرار الآن',
                    callback: () => {
                        findDuplicates('name-url', true); 
                    }
                };
                showToast(`وجدنا ${duplicatesFound} قناة مكررة.`, 'info', 8000, action);
            }

            isMerged = !isInitialLoad;
            isSorted = false;
            updateAndRefreshUI(false);
        }
        
        async function mergePlaylists(event) { const files = event.target.files; if (!files.length) return; closeModal('mergeModal'); document.getElementById('loadingIndicator').style.display = 'block'; const newChannels = await Promise.all(Array.from(files).map(file => file.text().then(parsePlaylist))).then(results => results.flat()); if(newChannels.length > 0) { processNewChannels(newChannels, `تم دمج ${newChannels.length} قناة جديدة.`); } else { showToast("لم يتم العثور على قنوات في الملفات المختارة.", "info"); } document.getElementById('loadingIndicator').style.display = 'none'; event.target.value = ''; }
        function removeDuplicates(criteria = 'name-url') { const originalLength = channelsData.length; const seen = new Set(); channelsData = channelsData.filter(channel => { let key; const name = (channel.name || '').trim(); const url = (channel.url || '').trim(); const groupKey = (channel.groups || []).join(';'); if (criteria === 'name-url') key = `${name}-${url}`; else if (criteria === 'name') key = name; else if (criteria === 'name-url-group') key = `${name}-${url}-${groupKey}`; if (key && !seen.has(key)) { seen.add(key); return true; } return false; }); return originalLength - channelsData.length; }
        function removeDuplicatesManually() { if (channelsData.length === 0) return showToast("لا توجد قنوات", 'error'); openModal('removeDuplicatesModal'); }
        
        function showDuplicateCriteriaStep() {
            document.getElementById('duplicate-criteria-step').style.display = 'block';
            document.getElementById('duplicate-results-step').style.display = 'none';
        }

        function findDuplicates(criteria, openFromToast = false) {
            if (!criteria) {
                criteria = document.querySelector('input[name="duplicateCriteria"]:checked').value;
            }
            const duplicatesMap = new Map();

            channelsData.forEach((channel, index) => {
                let key;
                const name = (channel.name || '').trim();
                const url = (channel.url || '').trim();
                const groupKey = (channel.groups || []).join(';');
                if (criteria === 'name-url') key = `${name}-${url}`;
                else if (criteria === 'name') key = name;
                else if (criteria === 'name-url-group') key = `${name}-${url}-${groupKey}`;

                if (key && !duplicatesMap.has(key)) {
                    duplicatesMap.set(key, []);
                }
                if(key) duplicatesMap.get(key).push({ channel, index });
            });

            const duplicateGroups = Array.from(duplicatesMap.values()).filter(group => group.length > 1);
            
            if (duplicateGroups.length === 0) {
                showToast("لم يتم العثور على قنوات مكررة بناءً على هذا الشرط.", "info");
                return;
            }

            const resultsList = document.getElementById('duplicate-results-list');
            resultsList.innerHTML = '';
            duplicateGroups.forEach((group, groupIndex) => {
                const groupDiv = document.createElement('div');
                groupDiv.className = 'duplicate-group';
                
                const groupTitle = document.createElement('h4');
                groupTitle.textContent = `${group[0].channel.name}`;
                groupDiv.appendChild(groupTitle);

                group.forEach((item, itemIndex) => {
                    const itemDiv = document.createElement('div');
                    itemDiv.className = 'duplicate-channel-item';
                    
                    const radio = document.createElement('input');
                    radio.type = 'radio';
                    radio.name = `dup-group-${groupIndex}`;
                    radio.value = item.index;
                    radio.id = `dup-radio-${groupIndex}-${itemIndex}`;
                    if (itemIndex === 0) { 
                        radio.checked = true;
                    }

                    const label = document.createElement('label');
                    label.htmlFor = `dup-radio-${groupIndex}-${itemIndex}`;
                    
                    let logoHTML;
                    if (item.channel.logo) {
                        logoHTML = `<img src="${item.channel.logo}" class="dup-logo" onerror="this.style.display='none'; this.nextElementSibling.style.display='inline-block';"><span class="dup-logo-placeholder" style="display:none;">📺</span>`;
                    } else {
                        logoHTML = '<span class="dup-logo-placeholder">📺</span>';
                    }
                    
                    const infoIcon = `<span class="dup-info-icon" onclick="showDuplicateInfo(${item.index})">ⓘ</span>`;

                    label.innerHTML = `${logoHTML} ${item.channel.name}`;
                    
                    itemDiv.appendChild(radio);
                    itemDiv.appendChild(label);
                    itemDiv.appendChild(document.createRange().createContextualFragment(infoIcon));
                    groupDiv.appendChild(itemDiv);
                });
                resultsList.appendChild(groupDiv);
            });
            
            if(openFromToast) openModal('removeDuplicatesModal');
            document.getElementById('duplicate-criteria-step').style.display = 'none';
            document.getElementById('duplicate-results-step').style.display = 'block';
        }
        
        function showDuplicateInfo(index) {
            document.getElementById('removeDuplicatesModal').style.zIndex = '999';
            openEditModal(index, true); // Open in read-only mode
            document.getElementById('editModal').style.zIndex = '1001';
        }

        function executeDuplicateDeletion() {
            const radioGroups = document.querySelectorAll('#duplicate-results-list .duplicate-group');
            const indicesToKeep = new Set();
            radioGroups.forEach(group => {
                const selectedRadio = group.querySelector('input[type="radio"]:checked');
                if (selectedRadio) {
                    indicesToKeep.add(parseInt(selectedRadio.value));
                }
            });

            const indicesToRemove = new Set();
            radioGroups.forEach(group => {
                const allRadios = group.querySelectorAll('input[type="radio"]');
                allRadios.forEach(radio => {
                    const index = parseInt(radio.value);
                    if (!indicesToKeep.has(index)) {
                        indicesToRemove.add(index);
                    }
                });
            });

            if (indicesToRemove.size === 0) {
                return showToast("لم يتم تحديد أي قنوات للحذف.", "info");
            }
            
            const sortedIndicesToRemove = Array.from(indicesToRemove).sort((a,b) => b-a);

            sortedIndicesToRemove.forEach(index => {
                channelsData.splice(index, 1);
            });
            
            updateAndRefreshUI();
            closeModal('removeDuplicatesModal');
            showToast(`تم حذف ${sortedIndicesToRemove.length} قناة مكررة بنجاح.`, 'success');
        }

        async function processMultiUrlLoad() { document.body.classList.remove('show-status-dots'); const urlsText = document.getElementById('multiUrlTextarea').value; const urls = urlsText.split('\n').map(u => u.trim()).filter(u => u); if (urls.length === 0) { return showToast("يرجى إدخال رابط واحد على الأقل", "error"); } closeModal('multiUrlModal'); document.getElementById('loadingIndicator').style.display = 'block'; let allNewChannels = []; let failedCount = 0; for (const url of urls) { try { const response = await fetch(url); if (!response.ok) throw new Error(`فشل تحميل الرابط (الحالة: ${response.status})`); const content = await response.text(); const channelsFromUrl = parsePlaylist(content); allNewChannels.push(...channelsFromUrl); } catch (error) { failedCount++; console.error(`خطأ في تحميل الرابط ${url}:`, error); } } document.getElementById('loadingIndicator').style.display = 'none'; if (allNewChannels.length > 0) { channelsData = []; processNewChannels(allNewChannels, `تم تحميل ${allNewChannels.length} قناة بنجاح.`); showPlaylistControls(); } else { showToast("فشل تحميل أي قنوات من الروابط المقدمة", "error"); } }
        function createNewPlaylist() { document.body.classList.remove('show-status-dots'); channelsData = []; displayedChannels = []; selectedIndices.clear(); showPlaylistControls(); displayPaginatedChannels(); showToast('تم إنشاء قائمة جديدة فارغة', 'info'); }
        
        function executeSort() {
            const criteria = document.querySelector('input[name="sortCriteria"]:checked').value;
            const isDescending = document.getElementById('sort-descending').checked;
            
            if (criteria === 'moveBlock') {
                const from = parseInt(document.getElementById('moveFromIndex').value);
                const to = parseInt(document.getElementById('moveToIndex').value);
                const target = parseInt(document.getElementById('moveTargetIndex').value);

                if (isNaN(from) || isNaN(to) || isNaN(target)) { return showToast('يرجى ملء جميع حقول النقل بأرقام صحيحة', 'error'); }
                if (from > to) { return showToast('رقم البداية "من" يجب أن يكون أصغر من أو يساوي رقم النهاية "إلى"', 'error'); }
                const maxIndex = channelsData.length;
                if (from < 1 || to > maxIndex || target < 1 || target > maxIndex + 1) { return showToast(`الأرقام المدخلة خارج نطاق القائمة (1 - ${maxIndex})`, 'error'); }

                const fromIndex = from - 1;
                const toIndex = to - 1;
                const targetIndex = target - 1;
                
                const count = toIndex - fromIndex + 1;
                const blockToMove = channelsData.splice(fromIndex, count);
                channelsData.splice(targetIndex, 0, ...blockToMove);
                showToast(`تم نقل ${count} قناة إلى الموضع ${target} بنجاح`, 'success');
            } else {
                const scopeContainer = document.getElementById('sort-scope-container');
                const scope = (scopeContainer.style.display === 'none' || !document.getElementById('sort-scope-selector').value) ? 'all' : document.getElementById('sort-scope-selector').value;
                const sortFunction = (a, b) => (a.name || '').localeCompare(b.name || '', 'ar');
                
                let channelsToSort;
                let originalIndices;

                if (scope === 'filtered') {
                    channelsToSort = [...displayedChannels];
                    originalIndices = displayedChannels.map(ch => channelsData.indexOf(ch)).sort((a, b) => a - b);
                } else if (scope === 'selected') {
                    originalIndices = Array.from(selectedIndices).sort((a,b) => a - b);
                    channelsToSort = originalIndices.map(index => channelsData[index]);
                } else {
                    channelsToSort = [...channelsData];
                }

                if (criteria === 'alphabetical') {
                    channelsToSort.sort(sortFunction);
                } else if (criteria === 'tvg-chno') {
                    channelsToSort.sort((a, b) => (a.chno || 0) - (b.chno || 0));
                } else if (criteria === 'name') {
                    const term = document.getElementById('sortByNameField').value.toLowerCase().trim();
                    if (term) channelsToSort.sort((a, b) => (b.name.toLowerCase().includes(term) - a.name.toLowerCase().includes(term)) || sortFunction(a, b));
                    else channelsToSort.sort(sortFunction);
                } else if (criteria === 'group') {
                    const term = document.getElementById('sortByGroupField').value.toLowerCase().trim();
                    if (term) channelsToSort.sort((a, b) => {
                        const aHasGroup = a.groups && a.groups.some(g => g.toLowerCase().includes(term));
                        const bHasGroup = b.groups && b.groups.some(g => g.toLowerCase().includes(term));
                        return (bHasGroup - aHasGroup) || sortFunction(a, b);
                    });
                    else channelsToSort.sort(sortFunction);
                }
                
                if (isDescending && criteria !== 'tvg-chno') {
                    channelsToSort.reverse();
                }

                if (scope === 'all') {
                    channelsData = channelsToSort;
                } else {
                    originalIndices.forEach((originalIndex, i) => {
                        channelsData[originalIndex] = channelsToSort[i];
                    });
                }
                showToast(`تم فرز ${channelsToSort.length} قناة بنجاح`, 'success');
            }

            isSorted = true;
            isMerged = false;
            updateTvgChnoInAllChannels();
            searchChannels();
            closeModal('sortModal');
        }
        
        function executeGroupAction() {
            const action = document.querySelector('input[name="groupAction"]:checked').value;
            const selectedTarget = document.getElementById('groupSelector').value;
            const isFilteredResultTarget = selectedTarget === '__filtered__';
            const isSelectedResultTarget = selectedTarget === '__selected__';

            if (action === 'removeAll') {
                showConfirm('إزالة كل التصنيفات', 'هل أنت متأكد من إزالة جميع تصنيفات المجموعات؟ ستصبح كل القنوات غير مصنفة.', () => {
                    channelsData.forEach(channel => { channel.groups = []; });
                    showToast('تم إزالة جميع التصنيفات بنجاح', 'success');
                    updateAndRefreshUI();
                });
                return;
            }

            const getTargetChannels = () => {
                if (isFilteredResultTarget) return [...displayedChannels];
                if (isSelectedResultTarget) return Array.from(selectedIndices).map(index => channelsData[index]);
                const isUncategorized = selectedTarget === 'غير مصنفة';
                return channelsData.filter(channel => {
                    if (isUncategorized) return !channel.groups || channel.groups.length === 0;
                    return channel.groups && channel.groups.includes(selectedTarget);
                });
            };

            const targetChannels = getTargetChannels();
            if (targetChannels.length === 0 && !(isFilteredResultTarget || isSelectedResultTarget)) {
                showToast('لم يتم العثور على قنوات في المجموعة المحددة', 'info');
                return;
            }
            
            let confirmationMsg = '';
            if(isFilteredResultTarget) confirmationMsg = `نتيجة البحث والتصفية (${targetChannels.length} قناة)`;
            else if(isSelectedResultTarget) confirmationMsg = `القنوات المحددة (${targetChannels.length} قناة)`;
            else confirmationMsg = `مجموعة "${selectedTarget}"`;


            if (action === 'delete') {
                showConfirm('حذف القنوات', `هل أنت متأكد من حذف كل قنوات ${confirmationMsg}؟`, () => {
                    const originalCount = channelsData.length;
                    const targetIndices = new Set(targetChannels.map(ch => channelsData.indexOf(ch)));
                    channelsData = channelsData.filter((_, index) => !targetIndices.has(index));
                    const removedCount = originalCount - channelsData.length;
                    showToast(`تم حذف ${removedCount} قناة بنجاح`, 'success');
                    updateAndRefreshUI();
                });
            } else if (action === 'rename') {
                const newGroupNameString = document.getElementById('newGroupNameField').value.trim();
                const isAdditive = document.getElementById('rename-add-as-new').checked;
                const targetIndices = new Set(targetChannels.map(ch => channelsData.indexOf(ch)));
                const isUncategorized = selectedTarget === 'غير مصنفة';

                if (newGroupNameString === '' && !isAdditive) {
                     showConfirm('إزالة التصنيف', `هل أنت متأكد من إزالة التصنيف من ${confirmationMsg}؟`, () => {
                        let affectedChannels = 0;
                        channelsData.forEach((channel, index) => {
                            if (targetIndices.has(index)) {
                                if (isFilteredResultTarget || isSelectedResultTarget || isUncategorized) {
                                    channel.groups = [];
                                } else {
                                    channel.groups = channel.groups.filter(g => g !== selectedTarget);
                                }
                                affectedChannels++;
                            }
                        });
                        showToast(`تم إزالة التصنيف من ${affectedChannels} قناة بنجاح`, 'success');
                        updateAndRefreshUI();
                    });
                } else {
                    const newGroups = newGroupNameString.split(';').map(g => g.trim()).filter(g => g);
                    if (newGroups.length === 0) return;
                    
                    channelsData.forEach((channel, index) => {
                        if (targetIndices.has(index)) {
                            let currentGroups = new Set(channel.groups || []);
                            if (!isAdditive) {
                                if (isFilteredResultTarget || isSelectedResultTarget || isUncategorized) {
                                    currentGroups.clear();
                                } else {
                                    currentGroups.delete(selectedTarget);
                                }
                            }
                            newGroups.forEach(g => currentGroups.add(g));
                            channel.groups = Array.from(currentGroups);
                        }
                    });
                    showToast(`تم تعديل مجموعة ${targetIndices.size} قناة بنجاح`, 'success');
                    updateAndRefreshUI();
                }
            } else if (action === 'merge') {
                const mergeTargetGroup = document.getElementById('mergeTargetSelector').value;
                if (!mergeTargetGroup || selectedTarget === mergeTargetGroup) {
                    return showToast('يرجى اختيار مجموعة مختلفة للدمج معها.', 'error');
                }
                showConfirm('دمج المجموعات', `هل أنت متأكد من دمج كل قنوات "${selectedTarget}" في مجموعة "${mergeTargetGroup}"؟`, () => {
                    const targetIndices = new Set(targetChannels.map(ch => channelsData.indexOf(ch)));
                    let affectedCount = 0;
                    channelsData.forEach((channel, index) => {
                        if (targetIndices.has(index)) {
                            const currentGroups = new Set(channel.groups || []);
                            currentGroups.delete(selectedTarget);
                            currentGroups.add(mergeTargetGroup);
                            channel.groups = Array.from(currentGroups);
                            affectedCount++;
                        }
                    });
                    showToast(`تم دمج ${affectedCount} قناة بنجاح.`, 'success');
                    updateAndRefreshUI();
                });
            } else if (action === 'exportGroup') {
                if (targetChannels.length > 0) {
                    const content = createPlaylistContent('m3u', targetChannels);
                    let fileName = 'playlist.m3u';
                    if (isFilteredResultTarget) fileName = `نتيجة البحث (${targetChannels.length} قناة).m3u`;
                    else if (isSelectedResultTarget) fileName = `القنوات المحددة (${targetChannels.length} قناة).m3u`;
                    else fileName = `Group_${selectedTarget.replace(/[\/\\?%*:|"<>]/g, '-')}.m3u`;
                    
                    if(content) downloadFile(content, fileName, 'text/plain;charset=utf-8');
                } else {
                    showToast('لا توجد قنوات لتصديرها.', 'info');
                }
                closeModal('manageGroupsModal');
            }
        }


        function updateAndRefreshUI(closeModals = true) {
            updateTvgChnoInAllChannels();
            searchChannels();
            if (closeModals) {
                 if (document.getElementById('manageGroupsModal').style.display === 'flex') {
                    closeModal('manageGroupsModal');
                 }
            }
        }

        async function executeMerge() {
            const urlsText = document.getElementById('mergeUrlTextarea').value;
            const urls = urlsText.split('\n').map(u => u.trim()).filter(u => u);
            if (urls.length === 0) {
                return showToast("يرجى إدخال رابط واحد على الأقل للدمج", "error");
            }

            closeModal('mergeModal');
            document.getElementById('loadingIndicator').style.display = 'block';

            let allNewChannels = [];
            let failedCount = 0;

            for (const url of urls) {
                try {
                    const response = await fetch(url);
                    if (!response.ok) throw new Error(`Failed to fetch`);
                    const content = await response.text();
                    const channelsFromUrl = parsePlaylist(content);
                    allNewChannels.push(...channelsFromUrl);
                } catch (error) {
                    failedCount++;
                    console.error(`Error fetching/parsing URL ${url}:`, error);
                }
            }
            document.getElementById('loadingIndicator').style.display = 'none';

            if (allNewChannels.length > 0) {
                processNewChannels(allNewChannels, `تم دمج ${allNewChannels.length} قناة جديدة من ${urls.length - failedCount} رابط.`);
            } else {
                showToast(`فشل تحميل أي قنوات من ${urls.length} رابط.`, "error");
            }
        }
        
        function deleteChannel(index) { showConfirm('تأكيد الحذف', `هل أنت متأكد من حذف: ${channelsData[index].name}؟`, () => { channelsData.splice(index, 1); updateTvgChnoInAllChannels(); searchChannels(); showToast('تم حذف القناة بنجاح', 'success'); }); }
        function saveEdit() { const originalIndex = parseInt(document.getElementById('editOriginalIndex').value); let newIndex = parseInt(document.getElementById('editIndexField').value) - 1; if (!document.getElementById('editName').value || !document.getElementById('editUrl').value) return showToast("الاسم والرابط مطلوبان", 'error'); const groups = document.getElementById('editGroup').value.split(';').map(g => g.trim()).filter(g => g); const channel = { name: document.getElementById('editName').value, groups: groups, logo: document.getElementById('editLogo').value, url: document.getElementById('editUrl').value, originalExtinf: channelsData[originalIndex].originalExtinf, status: channelsData[originalIndex].status }; if (newIndex !== originalIndex && newIndex < channelsData.length) { channelsData.splice(originalIndex, 1); channelsData.splice(newIndex, 0, channel); } else { channelsData[originalIndex] = channel; } updateTvgChnoInAllChannels(); closeModal('editModal'); searchChannels(); populateGroupFilter(); }
        function saveNewChannel() { if (!document.getElementById('addName').value || !document.getElementById('addUrl').value) return showToast("الاسم والرابط مطلوبان", 'error'); let newIndex = parseInt(document.getElementById('addIndexField').value) - 1; const groups = document.getElementById('addGroup').value.split(';').map(g => g.trim()).filter(g => g); const newChannel = { name: document.getElementById('addName').value, groups: groups, logo: document.getElementById('addLogo').value, url: document.getElementById('addUrl').value, status: 'unchecked' }; if (newIndex >= 0 && newIndex <= channelsData.length) { channelsData.splice(newIndex, 0, newChannel); } else { channelsData.push(newChannel); } updateTvgChnoInAllChannels(); closeModal('addModal'); searchChannels(); populateGroupFilter(); showToast('تمت إضافة القناة بنجاح', 'success'); }
        function openAddModal() { document.getElementById('addIndexField').value = channelsData.length + 1; ['addName', 'addGroup', 'addLogo', 'addUrl'].forEach(id => document.getElementById(id).value = ''); updateLogoPreview('addPreviewImage', ''); openModal('addModal'); }
        
        function openEditModal(index, readOnly = false) {
            const modal = document.getElementById('editModal');
            const channel = channelsData[index];
            if (!channel) return;
            
            document.getElementById('editIndexField').value = index + 1;
            document.getElementById('editName').value = channel.name || '';
            document.getElementById('editGroup').value = (channel.groups || []).join(';');
            document.getElementById('editLogo').value = channel.logo || '';
            document.getElementById('editUrl').value = channel.url || '';
            document.getElementById('editOriginalIndex').value = index;
            updateLogoPreview('previewImage', channel.logo);
            
            const fields = ['editIndexField', 'editName', 'editGroup', 'editLogo', 'editUrl'];
            fields.forEach(id => {
                document.getElementById(id).readOnly = readOnly;
            });
            
            document.querySelector('#editModal .modal-buttons button[onclick="saveEdit()"]').style.display = readOnly ? 'none' : 'inline-block';
            const cancelButton = document.querySelector('#editModal .modal-buttons button.cancel');
            cancelButton.textContent = readOnly ? 'إغلاق' : 'إلغاء';
            
            if (readOnly) {
                modal.style.zIndex = '1001';
            }
            openModal('editModal');
        }
        
        function openSortModal() {
            if (channelsData.length === 0) return showToast("لا توجد قنوات لفرزها", "error");

            const isFiltered = displayedChannels.length < channelsData.length;
            const hasSelection = selectedIndices.size > 0;
            const scopeSelector = document.getElementById('sort-scope-selector');
            const moveBlockOptionRow = document.getElementById('sort-move-row');
            
            if (isFiltered || hasSelection) {
                moveBlockOptionRow.style.display = 'none';
                document.getElementById('sort-alpha').checked = true;
            } else {
                moveBlockOptionRow.style.display = 'flex';
            }
            
            scopeSelector.innerHTML = '';
            
            if (isFiltered) {
                scopeSelector.innerHTML += `<option value="filtered">فرز نتيجة البحث والتصفية (${displayedChannels.length} قناة)</option>`;
            }
            if (hasSelection) {
                scopeSelector.innerHTML += `<option value="selected">فرز القنوات المحددة (${selectedIndices.size} قناة)</option>`;
            }
            if (!isFiltered) {
                scopeSelector.innerHTML += `<option value="all">فرز كامل القائمة (${channelsData.length} قناة)</option>`;
            }

            if (isFiltered) {
                scopeSelector.value = 'filtered';
            } else if (hasSelection) {
                scopeSelector.value = 'selected';
            }
            
            document.getElementById('sort-descending').checked = false;

            handleSortCriteriaChange();
            
            openModal('sortModal');
        }
        
        // --- START: MODIFICATION - Logic to handle smooth animation in sort modal
        function handleSortCriteriaChange() {
            const criteria = document.querySelector('input[name="sortCriteria"]:checked').value;
            const modalContent = document.querySelector('#sortModal .modal-content');
            
            // Define containers
            const nameContainer = document.getElementById('sortByNameInputContainer');
            const groupContainer = document.getElementById('sortByGroupInputContainer');
            const moveContainer = document.getElementById('moveBlockInputContainer');
            
            // Toggle visibility using classes
            nameContainer.classList.toggle('visible', criteria === 'name');
            groupContainer.classList.toggle('visible', criteria === 'group');
            moveContainer.classList.toggle('visible', criteria === 'moveBlock');

            // Handle compact layout for the moveBlock option
            if (modalContent) {
                modalContent.classList.toggle('compact-layout', criteria === 'moveBlock');
            }
            
            // Disable descending sort for tvg-chno
            document.getElementById('sort-descending').disabled = (criteria === 'tvg-chno');

            // Handle scope container visibility
            const scopeContainer = document.getElementById('sort-scope-container');
            const isFiltered = displayedChannels.length < channelsData.length;
            const hasSelection = selectedIndices.size > 0;

            if (criteria !== 'moveBlock' && (isFiltered || hasSelection)) {
                scopeContainer.style.display = 'block';
            } else {
                scopeContainer.style.display = 'none';
            }
        }
        // --- END: MODIFICATION ---
        
        function openManageGroupsModal() {
            if (channelsData.length === 0) return showToast("لا توجد قنوات لإدارة مجموعاتها", "error");
            const groupSelector = document.getElementById('groupSelector');
            groupSelector.innerHTML = '';

            const isFiltered = displayedChannels.length < channelsData.length;
            const hasSelection = selectedIndices.size > 0;

            let defaultSelection = null;

            if (isFiltered) {
                const option = document.createElement('option');
                option.value = '__filtered__';
                option.textContent = `نتيجة البحث والتصفية (${displayedChannels.length} قناة)`;
                groupSelector.appendChild(option);
                defaultSelection = '__filtered__';
            } 
            if (hasSelection) {
                const option = document.createElement('option');
                option.value = '__selected__';
                option.textContent = `القنوات المحددة (${selectedIndices.size} قناة)`;
                groupSelector.appendChild(option);
                if (!defaultSelection) {
                    defaultSelection = '__selected__';
                }
            }

            const allGroups = channelsData.flatMap(ch => (ch.groups && ch.groups.length) ? ch.groups : ['غير مصنفة']);
            const uniqueGroups = [...new Set(allGroups)];
            uniqueGroups.sort((a, b) => a.localeCompare(b, 'ar')).forEach(group => {
                const option = document.createElement('option');
                option.value = group;
                option.textContent = group;
                groupSelector.appendChild(option);
            });
            
            if(defaultSelection) {
                groupSelector.value = defaultSelection;
            }

            document.getElementById('action-rename').checked = true;
            document.getElementById('rename-add-as-new').checked = false;
            handleGroupSelectorChange();
            handleGroupActionChange();
            openModal('manageGroupsModal');
        }

        function handleGroupSelectorChange() {
            const groupSelector = document.getElementById('groupSelector');
            const mergeTargetSelector = document.getElementById('mergeTargetSelector');
            const selectedGroup = groupSelector.value;
            
            mergeTargetSelector.innerHTML = '';

            const allGroups = channelsData.flatMap(ch => (ch.groups && ch.groups.length) ? ch.groups : ['غير مصنفة']);
            const uniqueGroups = [...new Set(allGroups)];

            uniqueGroups
                .filter(group => group !== selectedGroup)
                .sort((a, b) => a.localeCompare(b, 'ar'))
                .forEach(group => {
                    const option = document.createElement('option');
                    option.value = group;
                    option.textContent = group;
                    mergeTargetSelector.appendChild(option);
            });
            
            document.getElementById('newGroupNameField').placeholder = "أدخل اسمًا جديدًا أو اتركه فارغًا";
            handleGroupActionChange();
        }
        
        // --- START: MODIFICATION - Logic to handle smooth animation in group management modal
        function handleGroupActionChange() {
            const action = document.querySelector('input[name="groupAction"]:checked').value;
            const renameContainer = document.getElementById('renameGroupInputContainer');
            const mergeContainer = document.getElementById('mergeGroupInputContainer');
            const groupSelector = document.getElementById('groupSelector');
            const isGlobalAction = action === 'removeAll';

            groupSelector.disabled = isGlobalAction;

            const isDynamicGroup = groupSelector.value === '__filtered__' || groupSelector.value === '__selected__';
            document.getElementById('action-merge').disabled = isDynamicGroup;

            if (isDynamicGroup && action === 'merge') {
                document.getElementById('action-rename').checked = true;
                setTimeout(handleGroupActionChange, 0);
                return; 
            }

            const currentAction = document.querySelector('input[name="groupAction"]:checked').value;
            renameContainer.classList.toggle('visible', currentAction === 'rename');
            mergeContainer.classList.toggle('visible', currentAction === 'merge');
        }
        // --- END: MODIFICATION ---
        
        function openMergeModal() {
            if (channelsData.length === 0) {
                return showToast("يجب تحميل قائمة تشغيل أولاً للدمج معها", "error");
            }
            document.getElementById('mergeUrlTextarea').value = '';
            document.getElementById('mergeOptionSelector').value = 'file';
            handleMergeOptionChange();
            openModal('mergeModal');
        }

        function handleMergeOptionChange() { const selectedOption = document.getElementById('mergeOptionSelector').value; document.getElementById('mergeFileOption').style.display = (selectedOption === 'file') ? 'block' : 'none'; document.getElementById('mergeUrlOption').style.display = (selectedOption === 'url') ? 'block' : 'none'; }
        
        function showPlaylistControls() {
            document.getElementById('uploadArea').style.display = 'none';
            document.getElementById('urlLoadContainer').style.display = 'none';
            document.getElementById('saveAddRow').style.display = 'flex';
            document.getElementById('toolsMergeRow').style.display = 'flex';
            ['openExportModalButton', 'addChannelButton', 'openSortModalButton', 'manageGroupsButton', 'openMergeModalButton', 'removeDuplicatesButton', 'openChannelCheckerButton', 'openFindReplaceButton', 'openSearchFilterModalButton', 'bulkActionsButton'].forEach(id => {
                const button = document.getElementById(id);
                if (button) button.style.display = 'inline-block';
            });
            updateBulkActionsUI();
        }
        
        function updateLogoPreview(imgId, url) { const preview = document.getElementById(imgId); preview.style.display = url ? 'block' : 'none'; if(url) preview.src = url; preview.onerror = () => preview.style.display = 'none'; }
        document.getElementById('editLogo').addEventListener('input', e => updateLogoPreview('previewImage', e.target.value)); document.getElementById('addLogo').addEventListener('input', e => updateLogoPreview('addPreviewImage', e.target.value));
        function buildUpdatedExtinf(originalExtinf, groups, logo, name, chno) { let line = originalExtinf ? originalExtinf.replace(/,.*$/, '').split(/\s+/).filter(p => !p.toLowerCase().startsWith('group-title=') && !p.toLowerCase().startsWith('tvg-logo=') && !p.toLowerCase().startsWith('tvg-chno=')).join(' ') : '#EXTINF:-1'; if (chno) line += ` tvg-chno="${chno}"`; if (logo) line += ` tvg-logo="${logo}"`; if (groups && groups.length > 0) line += ` group-title="${groups.join(';')}"`; return `${line},${name}`; }
        function updateTvgChnoInAllChannels() { channelsData.forEach((channel, index) => { channel.chno = index + 1; channel.originalExtinf = buildUpdatedExtinf(channel.originalExtinf, channel.groups, channel.logo, channel.name, channel.chno); }); }
        function openExportModal() { if (channelsData.length === 0) return showToast("لا توجد قنوات لتصديرها", "error"); openModal('exportModal'); }
        
        function executeExport() {
            const format = document.querySelector('input[name="exportFormat"]:checked').value;
            const numSelected = selectedIndices.size;

            const exportFunction = (channels) => {
                if (channels.length === 0) {
                    return showToast("لا توجد قنوات مختارة للتصدير.", "error");
                }
                if (format === 'm3u') savePlaylist(channels);
                else if (format === 'm3u8') savePlaylistAsM3u8(channels);
                else if (format === 'pls') savePlaylistAsPls(channels);
                else if (format === 'enigma2') saveEnigma2Bouquets(channels);
            };

            closeModal('exportModal');

            if (numSelected > 0) {
                showConfirm(
                    'تصدير القنوات المحددة',
                    `سيتم تصدير فقط القنوات المحددة (${numSelected} قناة). هل تريد المتابعة؟`,
                    () => {
                        const selectedChannels = Array.from(selectedIndices).map(index => channelsData[index]);
                        exportFunction(selectedChannels);
                        selectedIndices.clear();
                        searchChannels();
                    }
                );
                return;
            }

            const isFiltered = displayedChannels.length < channelsData.length && channelsData.length > 0;
            if (isFiltered) {
                showConfirm(
                    'تصدير القنوات المصفاة',
                    `سيتم تصدير فقط القنوات التي ظهرت بالبحث والتصفية (${displayedChannels.length} قناة). هل تريد المتابعة؟`,
                    () => { exportFunction(displayedChannels); }
                );
            } else {
                exportFunction(channelsData);
            }
        }

        const createPlaylistContent = (type, channelsToExport = channelsData) => { if (channelsToExport.length === 0) { showToast("لا يوجد قنوات للحفظ", "error"); return null; } if (type === 'pls') { return '[playlist]\nNumberOfEntries=' + channelsToExport.length + '\nVersion=2\n' + channelsToExport.map((ch, i) => `File${i+1}=${ch.url}\nTitle${i+1}=${ch.name}\nLength${i+1}=-1`).join('\n'); } return '#EXTM3U\n' + channelsToExport.map(ch => `${buildUpdatedExtinf(ch.originalExtinf, ch.groups, ch.logo, ch.name, ch.chno)}\n${ch.url}`).join('\n\n'); }
        function savePlaylist(channelsToExport = channelsData) { const c = createPlaylistContent('m3u', channelsToExport); if(c) downloadFile(c, 'playlist.m3u', 'text/plain;charset=utf-8'); }
        function savePlaylistAsM3u8(channelsToExport = channelsData) { const c = createPlaylistContent('m3u8', channelsToExport); if(c) downloadFile(c, 'application/x-mpegurl;charset=utf-8'); }
        function savePlaylistAsPls(channelsToExport = channelsData) { const c = createPlaylistContent('pls', channelsToExport); if(c) downloadFile(c, 'playlist.pls', 'text/plain;charset=utf-8'); }
        async function saveEnigma2Bouquets(channelsToExport = channelsData) {
            if (channelsToExport.length === 0) { showToast("لا يوجد قنوات للحفظ", "error"); return; }
            const zip = new JSZip();
            const allGroups = new Set(channelsToExport.flatMap(ch => (ch.groups && ch.groups.length) ? ch.groups : []));
            const bouquets = [];
            for (const group of allGroups) {
                const groupChannels = channelsToExport.filter(ch => ch.groups && ch.groups.includes(group));
                if (groupChannels.length === 0) continue;
                const sanitizedGroupName = group.replace(/[^a-zA-Z0-9]/g, '_').toLowerCase();
                const bouquetFileName = `userbouquet.${sanitizedGroupName}.tv`;
                bouquets.push(bouquetFileName);
                let bouquetContent = `#NAME ${group}\n`;
                groupChannels.forEach(ch => {
                    const encodedUrl = encodeURIComponent(ch.url).replace(/:/g, '%3a');
                    bouquetContent += `#SERVICE 4097:0:1:0:0:0:0:0:0:0:${encodedUrl}:${ch.name}\n`;
                });
                zip.file(bouquetFileName, bouquetContent);
            }
            let bouquetsTvContent = '#NAME Bouquets (TV)\n';
            bouquets.forEach(b => {
                bouquetsTvContent += `#SERVICE 1:7:1:0:0:0:0:0:0:0:FROM BOUQUET "${b}" ORDER BY bouquet\n`;
            });
            zip.file('bouquets.tv', bouquetsTvContent);
            try {
                const content = await zip.generateAsync({type:"blob"});
                const a = document.createElement('a');
                a.href = URL.createObjectURL(content);
                a.download = 'enigma2_bouquets.zip';
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                URL.revokeObjectURL(a.href);
            } catch(e) {
                showToast("حدث خطأ أثناء إنشاء ملف ZIP.", "error");
            }
        }

        function downloadFile(content, fileName, mimeType) { const blob = new Blob([content], { type: mimeType }); const a = document.createElement('a'); a.href = URL.createObjectURL(blob); const prefix = isMerged ? 'merged_' : isSorted ? 'sorted_' : ''; a.download = prefix + fileName; document.body.appendChild(a); a.click(); document.body.removeChild(a); URL.revokeObjectURL(a.href); }
        document.addEventListener('click', e => { if (e.target.classList.contains('delete-btn-icon')) deleteChannel(parseInt(e.target.dataset.index)); });
        
        function handleBulkActionChange() {
            const selectedAction = document.querySelector('input[name="bulkAction"]:checked').value;
            document.getElementById('bulk-move-input-container').style.display = (selectedAction === 'move') ? 'flex' : 'none';
        }

        function executeBulkAction() {
            const selectedAction = document.querySelector('input[name="bulkAction"]:checked').value;
            
            if (selectedAction === 'move') {
                const target = parseInt(document.getElementById('bulk-move-target-index').value);
                if (isNaN(target)) { return showToast('يرجى إدخال الموضع الهدف', 'error'); }
                const maxIndex = channelsData.length;
                if (target < 1 || target > maxIndex + 1) { return showToast(`الموضع الهدف خارج نطاق القائمة (1 - ${maxIndex})`, 'error'); }
                
                closeModal('bulkActionsModal');
                const targetIndex = target - 1;
                const sortedIndices = Array.from(selectedIndices).sort((a, b) => b - a);
                const blockToMove = [];
                sortedIndices.forEach(index => {
                    blockToMove.unshift(channelsData.splice(index, 1)[0]);
                });
                
                channelsData.splice(targetIndex, 0, ...blockToMove);
                showToast(`تم نقل ${blockToMove.length} قناة محددة إلى الموضع ${target} بنجاح`, 'success');
                selectedIndices.clear();
                updateTvgChnoInAllChannels();
                searchChannels();
                return;
            }

            closeModal('bulkActionsModal');

            switch(selectedAction) {
                case 'sort':
                    const indices = Array.from(selectedIndices).sort((a, b) => a - b);
                    const channelsToSort = indices.map(index => channelsData[index]);
                    channelsToSort.sort((a, b) => (a.name || '').localeCompare(b.name || '', 'ar'));
                    indices.forEach((originalIndex, i) => {
                        channelsData[originalIndex] = channelsToSort[i];
                    });
                    
                    selectedIndices.clear();
                    updateTvgChnoInAllChannels();
                    searchChannels();
                    showToast(`تم فرز ${indices.length} قناة محددة أبجدياً في أماكنها`, 'success');
                    break;
                case 'group':
                    openBulkEditGroupModal();
                    break;
                case 'removeGroup':
                    showConfirm('إزالة التصنيف', `هل أنت متأكد من إزالة التصنيف من ${selectedIndices.size} قناة محددة؟`, () => {
                        const count = selectedIndices.size;
                        selectedIndices.forEach(index => {
                            channelsData[index].groups = [];
                        });
                        selectedIndices.clear();
                        updateTvgChnoInAllChannels();
                        searchChannels();
                        populateGroupFilter();
                        showToast(`تم إزالة التصنيف من ${count} قناة بنجاح`, 'success');
                    });
                    break;
                case 'export':
                    exportSelected();
                    break;
                case 'delete':
                    deleteSelected();
                    break;
            }
        }

        function openBulkEditGroupModal() { if (selectedIndices.size === 0) return; document.getElementById('bulkNewGroupName').value = ''; openModal('bulkEditGroupModal'); }
        function executeBulkEditGroup() { const newGroups = document.getElementById('bulkNewGroupName').value.split(';').map(g => g.trim()).filter(g => g); const count = selectedIndices.size; selectedIndices.forEach(index => { channelsData[index].groups = newGroups; }); updateTvgChnoInAllChannels(); selectedIndices.clear(); searchChannels(); populateGroupFilter(); closeModal('bulkEditGroupModal'); showToast(`تم تعديل مجموعة ${count} قناة بنجاح`, 'success'); }
        function exportSelected() { if (selectedIndices.size === 0) return; openModal('exportModal'); }
        
        function openChannelCheckerModal() {
            if (channelsData.length === 0) return showToast("لا توجد قنوات لفحصها", "error");
            
            document.getElementById('checker-progress-text').textContent = "اضغط على زر 'بدء الفحص' للتحقق من حالة القنوات.";
            const progressBar = document.getElementById('checker-progress-bar');
            progressBar.style.width = '0%';
            progressBar.textContent = '0%';
            document.getElementById('checker-summary-text').textContent = '';

            document.querySelector('#channelCheckerModal .modal-buttons').style.display = 'flex';
            document.getElementById('start-check-btn').style.display = 'inline-block';
            document.getElementById('checker-cancel-btn').style.display = 'inline-block';
            document.getElementById('stop-check-btn').style.display = 'none';
            
            const actionsContainer = document.getElementById('checker-actions-container');
            actionsContainer.style.display = 'none';
            actionsContainer.querySelector('.dropdown-btn').textContent = 'إجراءات ▼';

            openModal('channelCheckerModal');
        }

        function stopChannelCheck() { isChecking = false; showToast("تم إيقاف فحص القنوات.", "info"); }
        
        async function executeChannelCheck() {
            isChecking = true;
            document.body.classList.add('show-status-dots');
            displayPaginatedChannels();

            const topButtonRow = document.querySelector('#channelCheckerModal .modal-buttons');
            topButtonRow.style.display = 'flex';
            document.getElementById('start-check-btn').style.display = 'none';
            document.getElementById('stop-check-btn').style.display = 'inline-block';
            document.getElementById('checker-cancel-btn').style.display = 'none';
            document.getElementById('checker-actions-container').style.display = 'none';

            const progressText = document.getElementById('checker-progress-text');
            const progressBar = document.getElementById('checker-progress-bar');
            const summaryText = document.getElementById('checker-summary-text');
            let okCount = 0;
            let failCount = 0;
            const total = channelsData.length;

            for (let i = 0; i < total; i++) {
                if (!isChecking) break;
                const channel = channelsData[i];
                channel.status = 'checking';
                updateStatusDot(i, 'checking');
                const progress = Math.round(((i + 1) / total) * 100);
                progressText.textContent = `جاري فحص القناة ${i + 1} من ${total}...`;
                progressBar.style.width = `${progress}%`;
                progressBar.textContent = `${progress}%`;
                const controller = new AbortController();
                const timeoutId = setTimeout(() => controller.abort(), 5000);
                try {
                    const response = await fetch(channel.url, { method: 'HEAD', signal: controller.signal, mode: 'no-cors' });
                    channel.status = 'checked-ok';
                    okCount++;
                } catch (error) {
                    channel.status = 'checked-fail';
                    failCount++;
                } finally {
                    clearTimeout(timeoutId);
                    updateStatusDot(i, channel.status);
                }
            }
            isChecking = false;
            summaryText.textContent = `اكتمل الفحص: ${okCount} قناة تعمل, ${failCount} قناة لا تعمل.`;
            
            const actionsContainer = document.getElementById('checker-actions-container');

            if (failCount > 0) {
                topButtonRow.style.display = 'none';
                
                document.getElementById('delete-failed-btn').style.display = 'block';
                document.getElementById('select-failed-btn').style.display = 'block';
                document.getElementById('export-working-btn').style.display = okCount > 0 ? 'block' : 'none';
                
                actionsContainer.querySelector('.dropdown-btn').textContent = `إجراءات (${failCount} قناة لا تعمل)`;
                actionsContainer.style.display = 'block';

            } else {
                topButtonRow.style.display = 'flex';
                document.getElementById('start-check-btn').style.display = 'none';
                document.getElementById('stop-check-btn').style.display = 'none';
                document.getElementById('checker-cancel-btn').style.display = 'inline-block';
                actionsContainer.style.display = 'none';
            }
        }
        
        function toggleCheckerActions() {
            document.getElementById("checker-actions-dropdown").classList.toggle("show");
        }
        window.onclick = function(event) {
            if (!event.target.matches('.dropdown-btn')) {
                document.querySelectorAll(".dropdown-content.show").forEach(openDropdown => {
                    openDropdown.classList.remove('show');
                });
            }
            document.querySelectorAll('.modal').forEach(m => {
                if (event.target === m) closeModal(m.id);
            });
        };

        function deleteFailedChannels() {
            toggleCheckerActions();
            const failedChannels = channelsData.filter(ch => ch.status === 'checked-fail');
            if (failedChannels.length === 0) return showToast("لا توجد قنوات لا تعمل لحذفها.", "info");
            
            showConfirm(
                'حذف القنوات التي لا تعمل',
                `هل أنت متأكد من حذف ${failedChannels.length} قناة لا تعمل؟`,
                () => {
                    channelsData = channelsData.filter(ch => ch.status !== 'checked-fail');
                    updateTvgChnoInAllChannels();
                    searchChannels();
                    closeModal('channelCheckerModal');
                    showToast(`تم حذف ${failedChannels.length} قناة بنجاح.`, 'success');
                }
            );
        }

        function exportWorkingChannels() {
            toggleCheckerActions();
            const workingChannels = channelsData.filter(ch => ch.status === 'checked-ok');
            if (workingChannels.length === 0) return showToast("لا توجد قنوات تعمل لتصديرها.", "info");
            
            const content = createPlaylistContent('m3u', workingChannels);
            if (content) {
                downloadFile(content, 'working_channels.m3u', 'text/plain;charset=utf-8');
                showToast(`تم تجهيز ملف يحتوي على ${workingChannels.length} قناة تعمل.`, 'success');
            }
            closeModal('channelCheckerModal');
        }

        function selectFailedChannels() {
            toggleCheckerActions();
            const failedChannels = channelsData.filter(ch => ch.status === 'checked-fail');
            if (failedChannels.length === 0) return showToast("لا توجد قنوات لا تعمل لتحديدها.", "info");
            
            displayedChannels = failedChannels;
            
            selectedIndices.clear();
            failedChannels.forEach(channel => {
                const originalIndex = channelsData.indexOf(channel);
                if (originalIndex !== -1) selectedIndices.add(originalIndex);
            });

            currentPage = 1;
            displayPaginatedChannels();
            closeModal('channelCheckerModal');
            showToast(`تم عرض وتحديد ${failedChannels.length} قناة لا تعمل.`, 'info');
        }

        function updateStatusDot(originalIndex, status) { const dot = document.querySelector(`.status-dot[data-index="${originalIndex}"]`); if (dot) { dot.className = `status-dot ${status}`; } }
        
        function setupSearchFilterModal() {
            const searchInput = document.getElementById('searchInput');
            const groupFilter = document.getElementById('groupFilter');
            const actionButton = document.getElementById('searchFilterActionButton');

            const initialSearchTerm = searchInput.value;
            const initialGroupFilter = groupFilter.value;

            populateGroupFilter('groupFilter');
            groupFilter.value = initialGroupFilter;

            const updateButtonState = () => {
                const currentSearchTerm = searchInput.value;
                const currentGroupFilter = groupFilter.value;

                const hasChanged = currentSearchTerm !== initialSearchTerm || currentGroupFilter !== initialGroupFilter;

                if (hasChanged) {
                    actionButton.textContent = 'تطبيق التصفية';
                    actionButton.onclick = applyFilter;
                    actionButton.classList.remove('cancel');
                } else {
                    if (isFilterActiveForButton) {
                        actionButton.textContent = 'إلغاء التصفية';
                        actionButton.onclick = cancelFilter;
                        actionButton.classList.add('cancel');
                    } else {
                        actionButton.textContent = 'إغلاق';
                        actionButton.onclick = () => closeModal('searchFilterModal');
                        actionButton.classList.add('cancel');
                    }
                }
            };
            
            searchInput.oninput = updateButtonState;
            groupFilter.onchange = updateButtonState;
            
            updateButtonState();
        }

        function applyFilter() {
            searchChannels();
            closeModal('searchFilterModal');
        }

        function cancelFilter() {
            document.getElementById('searchInput').value = '';
            document.getElementById('groupFilter').value = 'all';
            searchChannels();
            closeModal('searchFilterModal');
        }

        function openFindReplaceModal() {
            if (channelsData.length === 0) return showToast("لا توجد قنوات للبحث فيها", "error");

            document.getElementById('find-text').value = '';
            document.getElementById('replace-text').value = '';

            const scopeSelector = document.getElementById('replace-scope-selector');
            scopeSelector.innerHTML = ''; 

            const isFiltered = displayedChannels.length < channelsData.length;
            const hasSelection = selectedIndices.size > 0;

            if (isFiltered) {
                scopeSelector.innerHTML += `<option value="filtered">نتيجة البحث والتصفية (${displayedChannels.length} قناة)</option>`;
            }
            if (hasSelection) {
                scopeSelector.innerHTML += `<option value="selected">القنوات المحددة (${selectedIndices.size} قناة)</option>`;
            }
            if (!isFiltered) {
                 scopeSelector.innerHTML += `<option value="all">كل القنوات (${channelsData.length} قناة)</option>`;
            }

            if (isFiltered) {
                scopeSelector.value = 'filtered';
            } else if (hasSelection) {
                scopeSelector.value = 'selected';
            } else {
                scopeSelector.value = 'all';
            }
            
            openModal('findReplaceModal');
        }

        function executeFindAndReplace() {
            const findText = document.getElementById('find-text').value;
            const replaceText = document.getElementById('replace-text').value;
            if (!findText && replaceText) { return showToast("لا يمكن ترك حقل 'بحث عن' فارغًا عند الاستبدال.", "error"); }

            const findInName = document.getElementById('find-in-name').checked;
            const findInGroup = document.getElementById('find-in-group').checked;
            const findInUrl = document.getElementById('find-in-url').checked;
            if (!findInName && !findInGroup && !findInUrl) { return showToast("الرجاء تحديد حقل واحد على الأقل للبحث فيه.", "error"); }

            const scope = document.getElementById('replace-scope-selector').value;
            let targetIndices;

            if (scope === 'selected') {
                targetIndices = Array.from(selectedIndices);
            } else if (scope === 'filtered') {
                targetIndices = displayedChannels.map(ch => channelsData.indexOf(ch));
            } else {
                targetIndices = channelsData.map((_, i) => i);
            }

            let replacedCount = 0;
            let affectedChannels = 0;

            targetIndices.forEach(index => {
                if(index === -1) return; 
                const channel = channelsData[index];
                let channelModified = false;
                const regex = new RegExp(findText.replace(/[-\/\\^$*+?.()|[\]{}]/g, '\\$&'), 'g');

                if (findInName && channel.name && channel.name.includes(findText)) {
                    const original = channel.name;
                    channel.name = channel.name.replaceAll(findText, replaceText);
                    replacedCount += (original.match(regex) || []).length;
                    channelModified = true;
                }
                if (findInGroup && channel.groups && channel.groups.length > 0) {
                    channel.groups = channel.groups.map(group => {
                        if (group.includes(findText)) {
                            replacedCount += (group.match(regex) || []).length;
                            channelModified = true;
                            return group.replaceAll(findText, replaceText);
                        }
                        return group;
                    });
                }
                if (findInUrl && channel.url && channel.url.includes(findText)) {
                    const original = channel.url;
                    channel.url = channel.url.replaceAll(findText, replaceText);
                    replacedCount += (original.match(regex) || []).length;
                    channelModified = true;
                }
                if (channelModified) {
                    affectedChannels++;
                }
            });

            updateTvgChnoInAllChannels();
            searchChannels();
            closeModal('findReplaceModal');
            showToast(`تم استبدال النص ${replacedCount} مرة في ${affectedChannels} قناة.`, 'success');
        }
    </script>
</body>
</html>
