<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ù…Ø­Ø±Ø± Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„ØªØ´ØºÙŠÙ„ M3U/M3U8</title>
    <style>
        /* ØªØµÙ…ÙŠÙ… CSS Ø¹Ø§Ù… */
        body {
            font-family: 'Arial', sans-serif;
            background-color: #f4f4f9;
            color: #333;
            margin: 0;
            padding: 20px;
            direction: rtl;
        }
        .container {
            max-width: 1100px;
            width: 100%;
            margin: 20px auto;
            min-height: 400px;
            background: #fff;
            padding: 30px;
            border-radius: 12px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
            box-sizing: border-box;
        }
        h1 {
            color: #4CAF50;
            text-align: center;
            margin-bottom: 20px;
        }
        
        /* Ù…Ù†Ø·Ù‚Ø© Ø§Ù„Ø±ÙØ¹ */
        .upload-area {
            text-align: center;
            padding: 20px;
            border: 2px dashed #ccc;
            border-radius: 12px;
            margin-bottom: 20px;
            cursor: pointer;
            transition: border-color 0.3s;
            box-sizing: border-box;
        }
        .upload-area:hover, .upload-area.dragging {
            border-color: #4CAF50;
            background-color: #e8f5e9;
        }
        
        /* Ø²Ø± Ø§Ø®ØªÙŠØ§Ø± Ø§Ù„Ù…Ù„Ù */
        input[type="file"] {
            display: none;
        }
        .upload-label {
            background-color: #4CAF50;
            color: white;
            padding: 12px 25px;
            border-radius: 8px;
            cursor: pointer;
            font-weight: bold;
            display: inline-block;
            transition: background-color 0.3s;
            border: none;
            margin-top: 10px;
        }
        .upload-label:hover {
            background-color: #45a049;
        }

        /* Ø­Ø§ÙˆÙŠØ© Ø§Ù„ØªØ­Ù…ÙŠÙ„ Ù…Ù† Ø§Ù„Ø±Ø§Ø¨Ø· */
        #urlLoadContainer {
            width: 100%;
            max-width: 600px;
            margin: 20px auto 0 auto; /* ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ù‡Ø§Ù…Ø´ */
            text-align: center;
        }

        /* ØªÙ†Ø³ÙŠÙ‚ Ø­Ù‚Ù„ Ø§Ù„Ø±Ø§Ø¨Ø· */
        #urlInput {
            padding: 10px;
            width: 100%;
            max-width: 100%;
            margin: 0 0 10px 0;
            border-radius: 4px;
            border: 1px solid #ccc;
            box-sizing: border-box;
        }
        
        /* ØªÙ†Ø³ÙŠÙ‚ Ø§Ù„Ø£Ø²Ø±Ø§Ø± */
        #addChannelButton, #loadUrlButton, #createNewPlaylistButton, #manageGroupsButton, #openSortModalButton, #removeDuplicatesButton, #openMergeModalButton, #openExportModalButton {
            background-color: #007bff;
            color: white;
            padding: 10px 20px;
            border-radius: 6px;
            cursor: pointer;
            font-weight: bold;
            border: none;
            transition: background-color 0.3s;
            margin: 10px 5px;
            flex-shrink: 0; 
        }
        #addChannelButton:hover, #loadUrlButton:hover, #createNewPlaylistButton:hover, #manageGroupsButton:hover, #openSortModalButton:hover, #removeDuplicatesButton:hover, #openMergeModalButton:hover, #openExportModalButton:hover {
            background-color: #0056b3;
        }
        
        /* Ø¥Ø®ÙØ§Ø¡ Ø§Ù„Ø£Ø²Ø±Ø§Ø± Ø¨Ø´ÙƒÙ„ Ø§ÙØªØ±Ø§Ø¶ÙŠ */
        #manageGroupsButton, #openSortModalButton, #removeDuplicatesButton, #addChannelButton, #openMergeModalButton, #openExportModalButton {
            display: none; 
        }
        
        /* ØªÙ†Ø³ÙŠÙ‚ Ø§Ù„ØªØ­ÙƒÙ… Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠ */
        #mainControls {
            text-align: center;
            margin-bottom: 20px;
        }
        
        /* ØªØ±ØªÙŠØ¨ Ø§Ù„Ø£Ø²Ø±Ø§Ø± ÙÙŠ Ø£Ø³Ø·Ø± Ù…ØªØ¹Ø¯Ø¯Ø© */
        .button-row {
            display: flex; 
            justify-content: center; 
            align-items: center;
            flex-wrap: wrap; 
            gap: 10px; 
            margin-bottom: 10px; 
        }

        #initialButtonsRow {
            justify-content: space-between;
        }
        #initialButtonsRow button {
            flex: 1;
            margin: 0;
        }
        
        /* ØªØµÙ…ÙŠÙ… Ù…ØªØ¬Ø§ÙˆØ¨ Ù„Ø¶Ù…Ø§Ù† Ø²Ø±ÙŠÙ† ÙÙ‚Ø· ÙÙŠ ÙƒÙ„ Ø³Ø·Ø± Ø¹Ù„Ù‰ Ø§Ù„Ø´Ø§Ø´Ø§Øª Ø§Ù„ØµØºÙŠØ±Ø© */
        @media (max-width: 768px) {
            #mainControls button {
                width: 45%; 
                margin: 5px 0;
            }
             #initialButtonsRow {
                flex-direction: column;
             }
             #initialButtonsRow button {
                width: 100%;
             }
            #urlInput {
                width: 100%; 
                max-width: 100%;
                margin: 5px auto;
            }
        }
        
        @media (min-width: 769px) {
            #mainControls button {
                width: auto;
                min-width: 150px;
            }
            #initialButtonsRow button {
                width: auto;
            }
        }

        /* ØªÙ†Ø³ÙŠÙ‚ Ø§Ù„Ø¨Ø­Ø« */
        #searchContainer {
            margin: 20px 0;
            text-align: center;
            display: none; 
        }
        #searchInput {
            padding: 10px;
            width: 300px;
            max-width: 100%;
            border: 1px solid #ccc;
            border-radius: 4px;
            box-sizing: border-box;
            font-size: 16px;
            outline: none;
            transition: border-color 0.3s;
        }
        #searchInput:focus {
            border-color: #4CAF50;
        }

        /* ØªÙ†Ø³ÙŠÙ‚ Ø§Ù„Ø¬Ø¯ÙˆÙ„ */
        #results {
            text-align: center;
            display: flex;
            justify-content: center;
        }
        table {
            width: 95%;
            border-collapse: collapse;
            margin: 20px auto;
            table-layout: fixed;
        }
        th, td {
            border: 1px solid #ddd;
            padding: 8px;
            text-align: center;
            box-sizing: border-box;
            overflow: hidden;
            vertical-align: middle;
        }
        th {
            background-color: #4CAF50;
            color: white;
        }
        tr:nth-child(even) {
            background-color: #f2f2f2;
        }

        /* ØªØ­Ø¯ÙŠØ¯ Ø£Ø­Ø¬Ø§Ù… Ø§Ù„Ø£Ø¹Ù…Ø¯Ø© - ØªÙ… Ø§Ù„ØªØ¹Ø¯ÙŠÙ„ Ù‡Ù†Ø§ */
        table th:nth-child(1), table td:nth-child(1) { width: 8%; min-width: 60px; } /* Ø²ÙŠØ§Ø¯Ø© Ø§Ù„Ø¹Ø±Ø¶ */
        table th:nth-child(2), table td:nth-child(2) { width: 10%; min-width: 50px; }
        table th:nth-child(3), table td:nth-child(3) { width: 47%; min-width: 100px; } /* ØªÙ‚Ù„ÙŠÙ„ Ø§Ù„Ø¹Ø±Ø¶ Ù‚Ù„ÙŠÙ„Ø§Ù‹ Ù„Ù„ØªØ¹ÙˆÙŠØ¶ */
        table th:nth-child(4), table td:nth-child(4) { width: 20%; min-width: 80px; }
        table th:nth-child(5), table td:nth-child(5) { width: 15%; min-width: 60px; }

        /* ØªÙ†Ø³ÙŠÙ‚ Ø§Ù„ØµÙˆØ±Ø© Ø§Ù„Ø±Ù…Ø²ÙŠØ© */
        td.logo img {
            width: 30px;
            height: 30px;
            object-fit: contain;
            display: block;
            margin: 0 auto;
        }
        td.logo .placeholder {
            font-size: 20px;
            text-align: center;
        }

        /* ØªÙ†Ø³ÙŠÙ‚ Ø§Ø³Ù… Ø§Ù„Ù‚Ù†Ø§Ø© */
        .channel-name {
            white-space: normal !important;
            word-break: break-word;
            overflow: hidden;
        }

        /* Ø¥Ø®ÙØ§Ø¡ Ø¹Ù…ÙˆØ¯ Ø§Ù„ØµÙˆØ±Ø© Ø¹Ù„Ù‰ Ø§Ù„Ø´Ø§Ø´Ø§Øª Ø§Ù„ØµØºÙŠØ±Ø© - ØªÙ… Ø§Ù„ØªØ¹Ø¯ÙŠÙ„ Ù‡Ù†Ø§ */
        @media (max-width: 600px) {
            .container { padding: 15px; margin: 10px auto; }
            .upload-area { padding: 15px; }
            table { font-size: 14px; }
            th, td { padding: 6px 3px; }
            table th:nth-child(1), table td:nth-child(1) { width: 15%; min-width: 55px; } /* Ø²ÙŠØ§Ø¯Ø© Ø§Ù„Ø¹Ø±Ø¶ */
            table th:nth-child(2), table td:nth-child(2) { display: none; }
            table th:nth-child(3), table td:nth-child(3) { width: 50%; min-width: 100px; } /* ØªÙ‚Ù„ÙŠÙ„ Ø§Ù„Ø¹Ø±Ø¶ Ù„Ù„ØªØ¹ÙˆÙŠØ¶ */
            table th:nth-child(4), table td:nth-child(4) { width: 20%; min-width: 60px; }
            table th:nth-child(5), table td:nth-child(5) { width: 15%; min-width: 45px; }
        }

        .error-message { color: red; font-weight: bold; margin-top: 15px; text-align: center; }
        
        .action-button {
            background: none; border: none; cursor: pointer; font-size: 1.2em;
            margin: 0 1px; padding: 5px 3px; display: inline-block; text-align: center;
            color: #007bff; font-weight: bold; transition: color 0.3s;
        }
        .action-button:hover { color: #0056b3; }
        .delete-btn { color: #f44336; }
        .delete-btn:hover { color: #d32f2f; }
        td.actions { text-align: center; vertical-align: middle; }

        /* Modal Styles */
        .modal {
            display: none; position: fixed; z-index: 1000; left: 0; top: 0;
            width: 100%; height: 100%; overflow: auto; background-color: rgba(0,0,0,0.4);
            padding-top: 60px;
        }
        .modal-content {
            background-color: #fefefe; margin: 5% auto; padding: 20px;
            border: 1px solid #888; width: auto; max-width: 500px;
            border-radius: 10px; position: relative; box-sizing: border-box;
            overflow-y: auto; min-height: 200px;
        }
        .close {
            color: #aaa; float: left; font-size: 28px; font-weight: bold;
        }
        .close:hover, .close:focus {
            color: #000; text-decoration: none; cursor: pointer;
        }
        .modal-content input[type="text"], .modal-content input[type="url"],
        .modal-content input[type="number"], .modal-content select {
            width: 95%; padding: 8px; margin: 10px 0; display: inline-block;
            border: 1px solid #ccc; border-radius: 4px; box-sizing: border-box;
        }
        .modal-content input[type="radio"] { margin: 10px 5px; }
        .modal-content button {
            background-color: #4CAF50; color: white; border: none; padding: 8px 12px;
            border-radius: 4px; cursor: pointer; margin-left: 3px;
            box-sizing: border-box; min-width: 80px;
        }
        .modal-content button.cancel { background-color: #f44336; }
        .modal-content button:hover { opacity: 0.8; }
        .modal-row { display: flex; align-items: center; margin-bottom: 10px; }
        .modal-row label { margin-left: 5px; cursor: pointer; }
        .modal-buttons {
            display: flex; justify-content: center; align-items: center; margin-top: 25px;
            flex-wrap: wrap; gap: 10px; width: 100%;
        }
        
        #loadingIndicator { font-weight: bold; color: #4CAF50; text-align: center; margin: 20px; }
        #logoPreview img, #addPreviewImage { max-width: 50px; max-height: 50px; display: none; }

        /* Styles for new dropdown-based modal */
        #mergeModal .modal-content-body {
            padding: 15px;
            text-align: center;
        }
        #mergeOptionSelector {
            width: 100%;
            padding: 10px;
            font-size: 1em;
            margin-bottom: 20px;
        }
        .merge-option-container {
            padding: 10px;
        }
        .merge-option-container p {
             margin-bottom: 20px;
             color: #666;
        }
         .merge-option-container button {
             background-color: #007bff;
             color: white;
             padding: 10px 25px;
             font-size: 1em;
         }
         .merge-option-container button:hover {
            background-color: #0056b3;
            opacity: 1;
        }

    </style>
</head>
<body>
    <div class="container">
        <h1>Ù…Ø­Ø±Ø± Ù‚Ø§Ø¦Ù…Ø© ØªØ´ØºÙŠÙ„ M3U/M3U8</h1>
        
        <div id="loadingIndicator" style="display: none;"><p>Ø¬Ø§Ø±Ù Ø§Ù„ØªØ­Ù…ÙŠÙ„...</p></div>
        
        <div id="mainControls" style="text-align: center;">
            <label for="fileInput" id="uploadArea" class="upload-area" ondrop="handleDrop(event)" ondragover="handleDragOver(event)">
                <p style="font-size: 1.1em; font-weight: bold;">Ø§Ø¶ØºØ· Ù„Ø±ÙØ¹ Ù…Ù„Ù Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„ØªØ´ØºÙŠÙ„</p>
                <span class="upload-label">Ø§Ø®ØªÙŠØ§Ø± Ù…Ù„Ù M3U Ø£Ùˆ M3U8</span>
            </label>
            
            <div id="urlLoadContainer">
                 <input type="url" id="urlInput" placeholder="Ø£Ø¯Ø®Ù„ Ø±Ø§Ø¨Ø· Ù…Ù„Ù M3U/M3U8">
                 <div class="button-row" id="initialButtonsRow">
                    <button id="loadUrlButton" onclick="fetchPlaylistFromUrl()">ØªØ­Ù…ÙŠÙ„ Ù…Ù† Ø±Ø§Ø¨Ø·</button>
                    <button id="createNewPlaylistButton" onclick="createNewPlaylist()">Ø¥Ù†Ø´Ø§Ø¡ Ù‚Ø§Ø¦Ù…Ø© Ø¬Ø¯ÙŠØ¯Ø©</button>
                 </div>
            </div>

            <div class="button-row" id="saveAddRow">
                <button id="openExportModalButton" onclick="openExportModal()">ØªØµØ¯ÙŠØ± Ø§Ù„Ù‚Ø§Ø¦Ù…Ø©</button>
                <button id="addChannelButton" onclick="openAddModal()">Ø¥Ø¶Ø§ÙØ© Ù‚Ù†Ø§Ø©</button>
            </div>
            
            <div class="button-row" id="toolsMergeRow">
                <button id="openSortModalButton" onclick="openSortModal()">ÙØ±Ø² ÙˆØªØ±ØªÙŠØ¨</button>
                <button id="manageGroupsButton" onclick="openManageGroupsModal()">Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹Ø§Øª</button>
                <button id="openMergeModalButton" onclick="openMergeModal()">Ø¯Ù…Ø¬ Ù‚ÙˆØ§Ø¦Ù… ØªØ´ØºÙŠÙ„</button>
                <button id="removeDuplicatesButton" onclick="removeDuplicatesManually()">Ø¥Ø²Ø§Ù„Ø© Ø§Ù„ØªÙƒØ±Ø§Ø±</button>
            </div>
        </div>
        <div id="searchContainer" style="display: none;">
            <input type="text" id="searchInput" placeholder="Ø§Ø¨Ø­Ø« Ø¹Ù† Ù‚Ù†Ø§Ø©..." oninput="searchChannels()">
        </div>

        <input type="file" id="fileInput" accept=".m3u,.m3u8,.pls">
        <input type="file" id="mergeFileInput" accept=".m3u,.m3u8,.pls" multiple style="display: none;">
        <div id="results"></div>
    </div>

    <!-- Modals -->
    <div id="editModal" class="modal"><div class="modal-content"><span class="close" onclick="closeModal('editModal')">&times;</span><h2>ØªØ­Ø±ÙŠØ± Ø§Ù„Ù‚Ù†Ø§Ø©</h2><label for="editIndexField">Ø±Ù‚Ù… Ø§Ù„Ù‚Ù†Ø§Ø© Ø§Ù„Ø¬Ø¯ÙŠØ¯:</label><input type="number" id="editIndexField" min="1"><label for="editName">Ø§Ø³Ù… Ø§Ù„Ù‚Ù†Ø§Ø©:</label><input type="text" id="editName"><label for="editGroup">Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹Ø©:</label><input type="text" id="editGroup"><label for="editLogo">Ø±Ø§Ø¨Ø· Ø§Ù„ØµÙˆØ±Ø©:</label><input type="url" id="editLogo"><div id="logoPreview"><img id="previewImage"></div><label for="editUrl">Ø±Ø§Ø¨Ø· Ø§Ù„ØªØ´ØºÙŠÙ„:</label><input type="url" id="editUrl"><input type="hidden" id="editOriginalIndex"><div class="modal-buttons"><button onclick="saveEdit()">Ø­ÙØ¸</button><button onclick="closeModal('editModal')" class="cancel">Ø¥Ù„ØºØ§Ø¡</button></div></div></div>
    <div id="addModal" class="modal"><div class="modal-content"><span class="close" onclick="closeModal('addModal')">&times;</span><h2>Ø¥Ø¶Ø§ÙØ© Ù‚Ù†Ø§Ø© Ø¬Ø¯ÙŠØ¯Ø©</h2><label for="addIndexField">Ø±Ù‚Ù… Ø§Ù„Ù‚Ù†Ø§Ø©:</label><input type="number" id="addIndexField" min="1"><label for="addName">Ø§Ø³Ù… Ø§Ù„Ù‚Ù†Ø§Ø©:</label><input type="text" id="addName" required><label for="addGroup">Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹Ø©:</label><input type="text" id="addGroup"><label for="addLogo">Ø±Ø§Ø¨Ø· Ø§Ù„ØµÙˆØ±Ø©:</label><input type="url" id="addLogo"><div id="addLogoPreview"><img id="addPreviewImage"></div><label for="addUrl">Ø±Ø§Ø¨Ø· Ø§Ù„ØªØ´ØºÙŠÙ„:</label><input type="url" id="addUrl" required><div class="modal-buttons"><button onclick="saveNewChannel()">Ø¥Ø¶Ø§ÙØ©</button><button onclick="closeModal('addModal')" class="cancel">Ø¥Ù„ØºØ§Ø¡</button></div></div></div>
    <div id="removeDuplicatesModal" class="modal"><div class="modal-content"><span class="close" onclick="closeModal('removeDuplicatesModal')">&times;</span><h2>Ø¥Ø²Ø§Ù„Ø© Ø§Ù„ØªÙƒØ±Ø§Ø±</h2><label>Ø§Ø®ØªØ± Ø§Ù„Ø´Ø±Ø·:</label><div class="modal-row"><input type="radio" id="crit-name" name="duplicateCriteria" value="name" checked><label for="crit-name">Ø§Ù„Ø§Ø³Ù… ÙÙ‚Ø·</label></div><div class="modal-row"><input type="radio" id="crit-name-url" name="duplicateCriteria" value="name-url"><label for="crit-name-url">Ø§Ù„Ø§Ø³Ù… + Ø§Ù„Ø±Ø§Ø¨Ø·</label></div><div class="modal-row"><input type="radio" id="crit-name-url-group" name="duplicateCriteria" value="name-url-group"><label for="crit-name-url-group">Ø§Ù„Ø§Ø³Ù… + Ø§Ù„Ø±Ø§Ø¨Ø· + Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹Ø©</label></div><div class="modal-buttons"><button onclick="executeRemoveDuplicates()">Ø¥Ø²Ø§Ù„Ø©</button><button onclick="closeModal('removeDuplicatesModal')" class="cancel">Ø¥Ù„ØºØ§Ø¡</button></div></div></div>
    <div id="sortModal" class="modal"><div class="modal-content"><span class="close" onclick="closeModal('sortModal')">&times;</span><h2>ÙØ±Ø² ÙˆØªØ±ØªÙŠØ¨ Ø§Ù„Ù‚Ù†ÙˆØ§Øª</h2><div class="modal-row"><input type="radio" id="sort-alpha" name="sortCriteria" value="alphabetical" checked onchange="handleSortCriteriaChange()"><label for="sort-alpha">ÙØ±Ø² Ø£Ø¨Ø¬Ø¯ÙŠ</label></div><div class="modal-row"><input type="radio" id="sort-name" name="sortCriteria" value="name" onchange="handleSortCriteriaChange()"><label for="sort-name">Ø­Ø³Ø¨ Ø§Ø³Ù… Ø§Ù„Ù‚Ù†Ø§Ø©</label></div><div id="sortByNameInputContainer" style="display: none; margin-right: 25px;"><input type="text" id="sortByNameField" placeholder="Ø£Ø¯Ø®Ù„ Ø§Ø³Ù… Ø§Ù„Ù‚Ù†Ø§Ø© (Ù…Ø«Ø§Ù„: mbc)"></div><div class="modal-row"><input type="radio" id="sort-group" name="sortCriteria" value="group" onchange="handleSortCriteriaChange()"><label for="sort-group">Ø­Ø³Ø¨ Ø§Ø³Ù… Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹Ø©</label></div><div id="sortByGroupInputContainer" style="display: none; margin-right: 25px;"><input type="text" id="sortByGroupField" placeholder="Ø£Ø¯Ø®Ù„ Ø§Ø³Ù… Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹Ø©"></div><div class="modal-buttons"><button onclick="executeSort()">ØªØ·Ø¨ÙŠÙ‚</button><button onclick="closeModal('sortModal')" class="cancel">Ø¥Ù„ØºØ§Ø¡</button></div></div></div>
    <div id="manageGroupsModal" class="modal"><div class="modal-content"><span class="close" onclick="closeModal('manageGroupsModal')">&times;</span><h2>Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹Ø§Øª</h2><label for="groupSelector">Ø§Ø®ØªØ± Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹Ø©:</label><select id="groupSelector"></select><label>Ø§Ø®ØªØ± Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡:</label><div class="modal-row"><input type="radio" id="action-rename" name="groupAction" value="rename" checked onchange="handleGroupActionChange()"><label for="action-rename">Ø¥Ø¹Ø§Ø¯Ø© ØªØ³Ù…ÙŠØ©</label></div><div id="renameGroupInputContainer" style="margin-right: 25px;"><input type="text" id="newGroupNameField" placeholder="Ø£Ø¯Ø®Ù„ Ø§Ù„Ø§Ø³Ù… Ø§Ù„Ø¬Ø¯ÙŠØ¯ Ù„Ù„Ù…Ø¬Ù…ÙˆØ¹Ø©"></div><div class="modal-row"><input type="radio" id="action-delete" name="groupAction" value="delete" onchange="handleGroupActionChange()"><label for="action-delete">Ø­Ø°Ù Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹Ø©</label></div><div class="modal-row"><input type="radio" id="action-split" name="groupAction" value="split" onchange="handleGroupActionChange()"><label for="action-split">ÙØµÙ„ Ø£Ùˆ Ø§Ø³ØªØ®Ø±Ø§Ø¬ Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹Ø©</label></div><div class="modal-buttons"><button onclick="executeGroupAction()">ØªÙ†ÙÙŠØ°</button><button onclick="closeModal('manageGroupsModal')" class="cancel">Ø¥Ù„ØºØ§Ø¡</button></div></div></div>
    
    <!-- REDESIGNED MERGE MODAL (DROPDOWN) -->
    <div id="mergeModal" class="modal">
        <div class="modal-content">
            <span class="close" onclick="closeModal('mergeModal')">&times;</span>
            <h2>Ø®ÙŠØ§Ø±Ø§Øª Ø§Ù„Ø¯Ù…Ø¬</h2>
            <div class="modal-content-body">
                <label for="mergeOptionSelector" style="display:block; margin-bottom: 5px; text-align: right;">Ø§Ø®ØªØ± Ø·Ø±ÙŠÙ‚Ø© Ø§Ù„Ø¯Ù…Ø¬:</label>
                <select id="mergeOptionSelector" onchange="handleMergeOptionChange()">
                    <option value="file" selected>Ù…Ù† Ù…Ù„Ù</option>
                    <option value="url">Ù…Ù† Ø±Ø§Ø¨Ø·</option>
                </select>

                <div id="mergeFileOption" class="merge-option-container" style="display: block;">
                    <p>Ø§Ø®ØªØ± Ù…Ù„Ù Ø£Ùˆ Ø£ÙƒØ«Ø± Ù„Ø¯Ù…Ø¬Ù‡ Ù…Ø¹ Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø­Ø§Ù„ÙŠØ©.</p>
                    <button onclick="document.getElementById('mergeFileInput').click()">Ø§Ø®ØªÙŠØ§Ø± Ù…Ù„ÙØ§Øª</button>
                </div>

                <div id="mergeUrlOption" class="merge-option-container" style="display: none;">
                    <p>Ø£Ø¯Ø®Ù„ Ø±Ø§Ø¨Ø· Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„ØªØ´ØºÙŠÙ„ Ù„ÙŠØªÙ… Ø¯Ù…Ø¬Ù‡Ø§.</p>
                    <input type="url" id="mergeUrlInput" placeholder="https://example.com/playlist.m3u" style="width: 100%; margin-bottom: 20px;">
                    <button onclick="executeMerge()">Ø¯Ù…Ø¬ Ø§Ù„Ø±Ø§Ø¨Ø·</button>
                </div>
            </div>
        </div>
    </div>
    
    <div id="exportModal" class="modal"><div class="modal-content"><span class="close" onclick="closeModal('exportModal')">&times;</span><h2>ØªØµØ¯ÙŠØ± Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„ØªØ´ØºÙŠÙ„</h2><p>Ø§Ø®ØªØ± Ø§Ù„ØµÙŠØºØ© Ø§Ù„Ù…Ø·Ù„ÙˆØ¨Ø© Ù„Ù„Ø­ÙØ¸:</p><div class="modal-row"><input type="radio" id="export-m3u" name="exportFormat" value="m3u" checked><label for="export-m3u">M3U</label></div><div class="modal-row"><input type="radio" id="export-m3u8" name="exportFormat" value="m3u8"><label for="export-m3u8">M3U8</label></div><div class="modal-row"><input type="radio" id="export-pls" name="exportFormat" value="pls"><label for="export-pls">PLS</label></div><div class="modal-buttons"><button onclick="executeExport()">ØªØµØ¯ÙŠØ±</button><button onclick="closeModal('exportModal')" class="cancel">Ø¥Ù„ØºØ§Ø¡</button></div></div></div>


    <script>
        let channelsData = [];
        let isMerged = false; 
        let isSorted = false; 

        document.addEventListener('DOMContentLoaded', function() {
            // Initial view elements
            document.getElementById('uploadArea').style.display = 'block';
            document.getElementById('urlLoadContainer').style.display = 'block';

            // Playlist view elements (initially hidden)
            document.getElementById('saveAddRow').style.display = 'none';
            document.getElementById('toolsMergeRow').style.display = 'none';
            document.getElementById('searchContainer').style.display = 'none';
            
            // Hide individual buttons inside the rows too
            ['openExportModalButton', 'addChannelButton', 'openSortModalButton', 'manageGroupsButton', 'openMergeModalButton', 'removeDuplicatesButton'].forEach(id => {
                const button = document.getElementById(id);
                if (button) button.style.display = 'none';
            });
             document.getElementById('results').innerHTML = '';
        });

        document.getElementById('fileInput').addEventListener('change', handleFileSelect);
        document.getElementById('mergeFileInput').addEventListener('change', mergePlaylists);

        function handleDragOver(event) { event.preventDefault(); event.currentTarget.classList.add('dragging'); }
        function handleDrop(event) {
            event.preventDefault();
            event.currentTarget.classList.remove('dragging');
            const files = event.dataTransfer.files;
            if (files.length > 0) {
                document.getElementById('fileInput').files = files;
                handleFileSelect({ target: { files } });
            }
        }
        document.getElementById('uploadArea').addEventListener('dragenter', (e) => { e.preventDefault(); e.currentTarget.classList.add('dragging'); });
        document.getElementById('uploadArea').addEventListener('dragleave', (e) => { e.preventDefault(); e.currentTarget.classList.remove('dragging'); });

        function handleFileSelect(event) {
            const file = event.target.files[0];
            if (!file) return;
            const fileName = file.name.toLowerCase();
            if (!/\.(m3u|m3u8|pls)$/.test(fileName)) {
                return displayError("ÙŠØ±Ø¬Ù‰ Ø§Ø®ØªÙŠØ§Ø± Ù…Ù„Ù Ø¨Ø§Ù…ØªØ¯Ø§Ø¯ M3U, M3U8, Ø£Ùˆ PLS.");
            }
            document.getElementById('loadingIndicator').style.display = 'block';
            const reader = new FileReader();
            reader.onload = function(e) {
                channelsData = parsePlaylist(e.target.result);
                if (channelsData.length > 0) {
                    updateTvgChnoInAllChannels();
                    displayChannels(channelsData);
                    showPlaylistControls();
                    isMerged = false; isSorted = false;
                } else {
                    displayError("Ø§Ù„Ù…Ù„Ù Ø§Ù„Ù…Ø®ØªØ§Ø± Ù„Ø§ ÙŠØ­ØªÙˆÙŠ Ø¹Ù„Ù‰ Ù‚Ù†ÙˆØ§Øª ØµØ§Ù„Ø­Ø©.");
                }
                document.getElementById('loadingIndicator').style.display = 'none';
            };
            reader.readAsText(file, 'UTF-8');
        }
        
        function parsePlaylist(content) {
            const lines = content.split('\n');
            const channels = [];
            let currentInfo = '';

            for (const line of lines) {
                const trimmedLine = line.trim();
                if (trimmedLine.startsWith('#EXTINF')) {
                    currentInfo = trimmedLine;
                } else if (currentInfo && !trimmedLine.startsWith('#') && trimmedLine.length > 0) {
                    const name = currentInfo.match(/,([^,]*)$/)?.[1].trim() || 'Ù‚Ù†Ø§Ø© ØºÙŠØ± Ù…Ø¹Ø±ÙˆÙØ©';
                    const group = currentInfo.match(/group-title="([^"]*)"/i)?.[1] || '';
                    const logo = currentInfo.match(/tvg-logo="([^"]*)"/i)?.[1] || '';
                    const chno = parseInt(currentInfo.match(/tvg-chno="([^"]*)"/i)?.[1]) || 0;
                    
                    channels.push({ name, group, logo, chno, url: trimmedLine, originalExtinf: currentInfo });
                    currentInfo = '';
                }
            }
            return channels;
        }

        async function mergePlaylists(event) {
            const files = event.target.files;
            if (!files.length) return;
            closeModal('mergeModal');
            document.getElementById('loadingIndicator').style.display = 'block';
            
            const newChannels = await Promise.all(Array.from(files).map(file => file.text().then(parsePlaylist))).then(results => results.flat());
            channelsData.push(...newChannels);
            
            const duplicatesRemoved = removeDuplicates('name-url');
            updateTvgChnoInAllChannels();
            displayChannels(channelsData);
            showPlaylistControls();
            document.getElementById('loadingIndicator').style.display = 'none';
            event.target.value = '';
            isMerged = true; isSorted = false;
            alert(`ØªÙ… Ø¯Ù…Ø¬ Ø§Ù„Ù‚ÙˆØ§Ø¦Ù… ÙˆØ¥Ø²Ø§Ù„Ø© ${duplicatesRemoved} Ù‚Ù†Ø§Ø© Ù…ÙƒØ±Ø±Ø©.`);
        }

        function removeDuplicates(criteria = 'name') {
            const originalLength = channelsData.length;
            const seen = new Set();
            channelsData = channelsData.filter(channel => {
                let key;
                const name = (channel.name || '').trim();
                const url = (channel.url || '').trim();
                const group = (channel.group || '').trim();
                if (criteria === 'name-url') key = `${name}-${url}`;
                else if (criteria === 'name') key = name;
                else if (criteria === 'name-url-group') key = `${name}-${url}-${group}`;
                if (key && !seen.has(key)) {
                    seen.add(key);
                    return true;
                }
                return false;
            });
            return originalLength - channelsData.length;
        }

        function removeDuplicatesManually() {
            if (channelsData.length === 0) return displayError("Ù„Ø§ ØªÙˆØ¬Ø¯ Ù‚Ù†ÙˆØ§Øª.");
            document.getElementById('removeDuplicatesModal').style.display = 'block';
        }

        function executeRemoveDuplicates() {
            const criteria = document.querySelector('input[name="duplicateCriteria"]:checked').value;
            const duplicatesRemoved = removeDuplicates(criteria);
            updateTvgChnoInAllChannels();
            displayChannels(channelsData);
            closeModal('removeDuplicatesModal');
            alert(`ØªÙ… Ø¥Ø²Ø§Ù„Ø© ${duplicatesRemoved} Ù‚Ù†Ø§Ø© Ù…ÙƒØ±Ø±Ø©. Ø¹Ø¯Ø¯ Ø§Ù„Ù‚Ù†ÙˆØ§Øª Ø§Ù„Ø­Ø§Ù„ÙŠ: ${channelsData.length}.`);
        }

        function fetchPlaylistFromUrl() {
            const url = document.getElementById('urlInput').value;
            if (!url) return displayError("ÙŠØ±Ø¬Ù‰ Ø¥Ø¯Ø®Ø§Ù„ Ø±Ø§Ø¨Ø· ØµØ§Ù„Ø­.");

            document.getElementById('loadingIndicator').style.display = 'block';
            fetch(url)
                .then(response => { if (!response.ok) throw new Error('ÙØ´Ù„ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù…Ù„Ù.'); return response.text(); })
                .then(content => {
                    const newChannels = parsePlaylist(content);
                    if (newChannels.length === 0) return displayError("Ø§Ù„Ø±Ø§Ø¨Ø· Ù„Ø§ ÙŠØ­ØªÙˆÙŠ Ø¹Ù„Ù‰ Ù‚Ù†ÙˆØ§Øª.");
                    channelsData = newChannels;
                    isMerged = false; isSorted = false;
                    updateTvgChnoInAllChannels();
                    displayChannels(channelsData);
                    showPlaylistControls();
                })
                .catch(error => displayError(`Ø®Ø·Ø£: ${error.message}`))
                .finally(() => document.getElementById('loadingIndicator').style.display = 'none');
        }

        function createNewPlaylist() {
            channelsData = [];
            displayChannels([]);
            showPlaylistControls();
            isMerged = false; isSorted = false;
        }

        function openSortModal() {
            if (channelsData.length === 0) return displayError("Ù„Ø§ ØªÙˆØ¬Ø¯ Ù‚Ù†ÙˆØ§Øª Ù„ÙØ±Ø²Ù‡Ø§.");
            document.getElementById('sortModal').style.display = 'block';
        }

        function handleSortCriteriaChange() {
            const criteria = document.querySelector('input[name="sortCriteria"]:checked').value;
            document.getElementById('sortByNameInputContainer').style.display = criteria === 'name' ? 'block' : 'none';
            document.getElementById('sortByGroupInputContainer').style.display = criteria === 'group' ? 'block' : 'none';
        }

        function executeSort() {
            const criteria = document.querySelector('input[name="sortCriteria"]:checked').value;
            const sortFunction = (a, b) => a.name.localeCompare(b.name, 'ar');

            if (criteria === 'alphabetical') {
                channelsData.sort(sortFunction);
            } else if (criteria === 'name') {
                const term = document.getElementById('sortByNameField').value.toLowerCase().trim();
                if (term) channelsData.sort((a, b) => (b.name.toLowerCase().includes(term) - a.name.toLowerCase().includes(term)) || sortFunction(a, b));
            } else if (criteria === 'group') {
                const term = document.getElementById('sortByGroupField').value.toLowerCase().trim();
                if (term) channelsData.sort((a, b) => (((b.group || '').toLowerCase() === term) - ((a.group || '').toLowerCase() === term)) || sortFunction(a, b));
            }
            
            isSorted = true; isMerged = false;
            updateTvgChnoInAllChannels();
            displayChannels(channelsData);
            closeModal('sortModal');
        }

        function openManageGroupsModal() {
            if (channelsData.length === 0) return displayError("Ù„Ø§ ØªÙˆØ¬Ø¯ Ù‚Ù†ÙˆØ§Øª Ù„Ø¥Ø¯Ø§Ø±Ø© Ù…Ø¬Ù…ÙˆØ¹Ø§ØªÙ‡Ø§.");
            const groupSelector = document.getElementById('groupSelector');
            groupSelector.innerHTML = '';
            
            const groups = new Set(channelsData.map(ch => ch.group || 'ØºÙŠØ± Ù…ØµÙ†ÙØ©'));
            Array.from(groups).sort((a, b) => a.localeCompare(b, 'ar')).forEach(group => {
                const option = document.createElement('option');
                option.value = group;
                option.textContent = group;
                groupSelector.appendChild(option);
            });
            
            handleGroupActionChange();
            document.getElementById('manageGroupsModal').style.display = 'block';
        }
        
        function handleGroupActionChange() {
            const action = document.querySelector('input[name="groupAction"]:checked').value;
            document.getElementById('renameGroupInputContainer').style.display = action === 'rename' ? 'block' : 'none';
        }
        
        function executeGroupAction() {
            const selectedGroup = document.getElementById('groupSelector').value;
            const action = document.querySelector('input[name="groupAction"]:checked').value;
            const isUncategorized = selectedGroup === 'ØºÙŠØ± Ù…ØµÙ†ÙØ©';

            if (action === 'rename') {
                const newGroupName = document.getElementById('newGroupNameField').value.trim();
                if (newGroupName === null) return;
                channelsData.forEach(channel => {
                    if ((isUncategorized && !channel.group) || channel.group === selectedGroup) {
                        channel.group = newGroupName;
                    }
                });
                alert(`ØªÙ… Ø¥Ø¹Ø§Ø¯Ø© ØªØ³Ù…ÙŠØ© Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹Ø© "${selectedGroup}" Ø¥Ù„Ù‰ "${newGroupName || 'Ø¨Ø¯ÙˆÙ† Ø§Ø³Ù…'}".`);
            } 
            else if (action === 'delete') {
                if (!confirm(`Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† Ø­Ø°Ù ÙƒÙ„ Ù‚Ù†ÙˆØ§Øª Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹Ø© "${selectedGroup}"ØŸ`)) return;
                const originalCount = channelsData.length;
                channelsData = channelsData.filter(channel => !((isUncategorized && !channel.group) || channel.group === selectedGroup));
                const removedCount = originalCount - channelsData.length;
                alert(`ØªÙ… Ø­Ø°Ù ${removedCount} Ù‚Ù†Ø§Ø© Ù…Ù† Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹Ø© "${selectedGroup}".`);
            } 
            else if (action === 'split') {
                const groupChannels = channelsData.filter(channel => (isUncategorized && !channel.group) || channel.group === selectedGroup);
                if (groupChannels.length > 0) {
                    const content = '#EXTM3U\n' + groupChannels.map(ch => `${buildUpdatedExtinf(ch.originalExtinf, ch.group, ch.logo, ch.name, ch.chno)}\n${ch.url}`).join('\n\n');
                    const fileName = `Group_${selectedGroup.replace(/[\/\\?%*:|"<>]/g, '-')}.m3u`;
                    downloadFile(content, fileName, 'text/plain;charset=utf-8');
                } else {
                    alert('Ù„Ù… ÙŠØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ Ù‚Ù†ÙˆØ§Øª ÙÙŠ Ù‡Ø°Ù‡ Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹Ø©.');
                }
                closeModal('manageGroupsModal');
                return; 
            }

            updateTvgChnoInAllChannels();
            displayChannels(channelsData);
            closeModal('manageGroupsModal');
        }

        // --- MERGE MODAL FUNCTIONS (DROPDOWN) ---
        function openMergeModal() {
            if (channelsData.length === 0) return displayError("ÙŠØ¬Ø¨ ØªØ­Ù…ÙŠÙ„ Ù‚Ø§Ø¦Ù…Ø© ØªØ´ØºÙŠÙ„ Ø£ÙˆÙ„Ø§Ù‹ Ù„Ù„Ø¯Ù…Ø¬ Ù…Ø¹Ù‡Ø§.");
            document.getElementById('mergeUrlInput').value = '';
            document.getElementById('mergeOptionSelector').value = 'file'; // Set default
            handleMergeOptionChange(); // Show correct initial view
            document.getElementById('mergeModal').style.display = 'block';
        }

        function handleMergeOptionChange() {
            const selectedOption = document.getElementById('mergeOptionSelector').value;
            document.getElementById('mergeFileOption').style.display = (selectedOption === 'file') ? 'block' : 'none';
            document.getElementById('mergeUrlOption').style.display = (selectedOption === 'url') ? 'block' : 'none';
        }

        function executeMerge() {
            const url = document.getElementById('mergeUrlInput').value;
            if (!url) return alert("ÙŠØ±Ø¬Ù‰ Ø¥Ø¯Ø®Ø§Ù„ Ø±Ø§Ø¨Ø· Ù„Ù„Ø¯Ù…Ø¬.");
            
            closeModal('mergeModal');
            document.getElementById('loadingIndicator').style.display = 'block';

            fetch(url)
                .then(response => { if (!response.ok) throw new Error('ÙØ´Ù„ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù…Ù„Ù.'); return response.text(); })
                .then(content => {
                    const newChannels = parsePlaylist(content);
                    if (newChannels.length === 0) return displayError("Ø§Ù„Ø±Ø§Ø¨Ø· Ù„Ø§ ÙŠØ­ØªÙˆÙŠ Ø¹Ù„Ù‰ Ù‚Ù†ÙˆØ§Øª.");
                    
                    channelsData.push(...newChannels);
                    const duplicatesRemoved = removeDuplicates('name-url');
                    alert(`ØªÙ… Ø¯Ù…Ø¬ Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© ÙˆØ¥Ø²Ø§Ù„Ø© ${duplicatesRemoved} Ù‚Ù†Ø§Ø© Ù…ÙƒØ±Ø±Ø©.`);
                    isMerged = true; isSorted = false;
                    
                    updateTvgChnoInAllChannels();
                    displayChannels(channelsData);
                })
                .catch(error => displayError(`Ø®Ø·Ø£: ${error.message}`))
                .finally(() => document.getElementById('loadingIndicator').style.display = 'none');
        }

        function displayChannels(channels) {
            const resultsDiv = document.getElementById('results');
            resultsDiv.innerHTML = '';
            if (channels.length === 0) {
                resultsDiv.innerHTML = '<p>Ù„Ø§ ØªÙˆØ¬Ø¯ Ù‚Ù†ÙˆØ§Øª Ù„Ø¹Ø±Ø¶Ù‡Ø§.</p>';
                return;
            }
            const table = document.createElement('table');
            table.innerHTML = `<thead><tr><th>Ø±Ù‚Ù…</th><th>Ø§Ù„ØµÙˆØ±Ø©</th><th class="channel-name">Ø§Ø³Ù… Ø§Ù„Ù‚Ù†Ø§Ø©</th><th>Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹Ø©</th><th>Ø¥Ø¯Ø§Ø±Ø©</th></tr></thead><tbody>${channels.map((channel, index) => `<tr><td>${index + 1}</td><td class="logo">${channel.logo ? `<img src="${channel.logo}" alt="Logo" onerror="this.style.display='none'; this.nextElementSibling.style.display='block';">` : ''}<span class="placeholder" style="${channel.logo ? 'display:none;' : ''}">ğŸ“º</span></td><td class="channel-name">${channel.name || ''}</td><td>${channel.group || 'ØºÙŠØ± Ù…ØµÙ†ÙØ©'}</td><td class="actions"><button class="action-button edit-btn" data-index="${index}" title="ØªØ­Ø±ÙŠØ±">&#9998;</button><button class="action-button delete-btn" data-index="${index}" title="Ø­Ø°Ù">&#128465;</button></td></tr>`).join('')}</tbody>`;
            resultsDiv.appendChild(table);
        }

        function searchChannels() {
            const term = document.getElementById('searchInput').value.toLowerCase();
            if (!term) return displayChannels(channelsData);
            displayChannels(channelsData.filter(ch => ch.name.toLowerCase().includes(term) || (ch.group || '').toLowerCase().includes(term)));
        }

        function deleteChannel(index) {
            if (confirm(`Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† Ø­Ø°Ù: ${channelsData[index].name}ØŸ`)) {
                channelsData.splice(index, 1);
                updateTvgChnoInAllChannels();
                displayChannels(channelsData);
            }
        }

        function openEditModal(index) {
            const channel = channelsData[index];
            document.getElementById('editIndexField').value = index + 1;
            document.getElementById('editName').value = channel.name || '';
            document.getElementById('editGroup').value = channel.group || '';
            document.getElementById('editLogo').value = channel.logo || '';
            document.getElementById('editUrl').value = channel.url || '';
            document.getElementById('editOriginalIndex').value = index;
            updateLogoPreview('previewImage', channel.logo);
            document.getElementById('editModal').style.display = 'block';
        }

        function openAddModal() {
            document.getElementById('addIndexField').value = channelsData.length + 1;
            ['addName', 'addGroup', 'addLogo', 'addUrl'].forEach(id => document.getElementById(id).value = '');
            updateLogoPreview('addPreviewImage', '');
            document.getElementById('addModal').style.display = 'block';
        }

        function saveEdit() {
            const originalIndex = parseInt(document.getElementById('editOriginalIndex').value);
            let newIndex = parseInt(document.getElementById('editIndexField').value) - 1;
            if (!document.getElementById('editName').value || !document.getElementById('editUrl').value) return displayError("Ø§Ù„Ø§Ø³Ù… ÙˆØ§Ù„Ø±Ø§Ø¨Ø· Ù…Ø·Ù„ÙˆØ¨Ø§Ù†.");
            
            const channel = {
                name: document.getElementById('editName').value,
                group: document.getElementById('editGroup').value,
                logo: document.getElementById('editLogo').value,
                url: document.getElementById('editUrl').value,
                originalExtinf: channelsData[originalIndex].originalExtinf
            };

            if (newIndex !== originalIndex && newIndex >= 0 && newIndex < channelsData.length) {
                channelsData.splice(originalIndex, 1);
                channelsData.splice(newIndex, 0, channel);
            } else {
                channelsData[originalIndex] = channel;
            }
            
            updateTvgChnoInAllChannels();
            closeModal('editModal');
            displayChannels(channelsData);
        }

        function saveNewChannel() {
            if (!document.getElementById('addName').value || !document.getElementById('addUrl').value) return displayError("Ø§Ù„Ø§Ø³Ù… ÙˆØ§Ù„Ø±Ø§Ø¨Ø· Ù…Ø·Ù„ÙˆØ¨Ø§Ù†.");
            let newIndex = parseInt(document.getElementById('addIndexField').value) - 1;
            
            const newChannel = {
                name: document.getElementById('addName').value,
                group: document.getElementById('addGroup').value,
                logo: document.getElementById('addLogo').value,
                url: document.getElementById('addUrl').value
            };

            if (newIndex >= 0 && newIndex <= channelsData.length) {
                channelsData.splice(newIndex, 0, newChannel);
            } else {
                channelsData.push(newChannel);
            }
            updateTvgChnoInAllChannels();
            closeModal('addModal');
            displayChannels(channelsData);
        }

        function showPlaylistControls() {
            // Hide initial view
            document.getElementById('uploadArea').style.display = 'none';
            document.getElementById('urlLoadContainer').style.display = 'none';

            // Show playlist editing view
            document.getElementById('saveAddRow').style.display = 'flex';
            document.getElementById('toolsMergeRow').style.display = 'flex';
            document.getElementById('searchContainer').style.display = 'block';

            // Make individual buttons visible inside the rows
             ['openExportModalButton', 'addChannelButton', 'openSortModalButton', 'manageGroupsButton', 'openMergeModalButton', 'removeDuplicatesButton'].forEach(id => {
                const button = document.getElementById(id);
                if (button) button.style.display = 'inline-block';
            });
        }

        function closeModal(modalId) { document.getElementById(modalId).style.display = 'none'; }
        
        function updateLogoPreview(imgId, url) {
            const preview = document.getElementById(imgId);
            preview.style.display = url ? 'block' : 'none';
            if(url) preview.src = url;
            preview.onerror = () => preview.style.display = 'none';
        }
        document.getElementById('editLogo').addEventListener('input', e => updateLogoPreview('previewImage', e.target.value));
        document.getElementById('addLogo').addEventListener('input', e => updateLogoPreview('addPreviewImage', e.target.value));
        
        function buildUpdatedExtinf(originalExtinf, group, logo, name, chno) {
            let line = originalExtinf ? originalExtinf.replace(/,.*$/, '').split(/\s+/).filter(p => !p.toLowerCase().startsWith('group-title=') && !p.toLowerCase().startsWith('tvg-logo=') && !p.toLowerCase().startsWith('tvg-chno=')).join(' ') : '#EXTINF:-1';
            if (chno) line += ` tvg-chno="${chno}"`;
            if (logo) line += ` tvg-logo="${logo}"`;
            if (group) line += ` group-title="${group}"`;
            return `${line},${name}`;
        }
        
        function updateTvgChnoInAllChannels() {
            channelsData.forEach((channel, index) => {
                channel.chno = index + 1;
                channel.originalExtinf = buildUpdatedExtinf(channel.originalExtinf, channel.group, channel.logo, channel.name, channel.chno);
            });
        }

        function openExportModal() {
            if (channelsData.length === 0) return displayError("Ù„Ø§ ØªÙˆØ¬Ø¯ Ù‚Ù†ÙˆØ§Øª Ù„ØªØµØ¯ÙŠØ±Ù‡Ø§.");
            document.getElementById('exportModal').style.display = 'block';
        }

        function executeExport() {
            const format = document.querySelector('input[name="exportFormat"]:checked').value;
            if (format === 'm3u') savePlaylist();
            else if (format === 'm3u8') savePlaylistAsM3u8();
            else if (format === 'pls') savePlaylistAsPls();
            closeModal('exportModal');
        }

        const createPlaylistContent = (type) => {
            if (channelsData.length === 0) { displayError("Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ù‚Ù†ÙˆØ§Øª Ù„Ù„Ø­ÙØ¸."); return null; }
            if (type === 'pls') {
                return '[playlist]\nNumberOfEntries=' + channelsData.length + '\nVersion=2\n' + channelsData.map((ch, i) => `File${i+1}=${ch.url}\nTitle${i+1}=${ch.name}\nLength${i+1}=-1`).join('\n');
            }
            return '#EXTM3U\n' + channelsData.map(ch => `${ch.originalExtinf}\n${ch.url}`).join('\n\n');
        }
        
        function savePlaylist() { const c = createPlaylistContent('m3u'); if(c) downloadFile(c, 'playlist.m3u', 'text/plain;charset=utf-8'); }
        function savePlaylistAsM3u8() { const c = createPlaylistContent('m3u8'); if(c) downloadFile(c, 'application/x-mpegurl;charset=utf-8'); }
        function savePlaylistAsPls() { const c = createPlaylistContent('pls'); if(c) downloadFile(c, 'playlist.pls', 'text/plain;charset=utf-8'); }

        function downloadFile(content, fileName, mimeType) {
            const blob = new Blob([content], { type: mimeType });
            const a = document.createElement('a');
            a.href = URL.createObjectURL(blob);
            const prefix = isMerged ? 'merged_' : isSorted ? 'sorted_' : '';
            a.download = prefix + fileName;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(a.href);
        }

        function displayError(message) {
            const resultsDiv = document.getElementById('results');
            resultsDiv.innerHTML = `<p class="error-message">${message}</p>`;
            setTimeout(() => { 
                if (resultsDiv.querySelector('.error-message')) {
                    resultsDiv.innerHTML = '';
                    if (channelsData.length > 0) displayChannels(channelsData);
                }
             }, 5000);
        }

        document.addEventListener('click', e => {
            if (e.target.classList.contains('edit-btn')) openEditModal(parseInt(e.target.dataset.index));
            if (e.target.classList.contains('delete-btn')) deleteChannel(parseInt(e.target.dataset.index));
        });
        window.onclick = e => document.querySelectorAll('.modal').forEach(m => { if (e.target === m) closeModal(m.id); });
    </script>
</body>
</html>